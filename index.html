<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Financial Tracker</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 2. Set default font to match the app */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for animations or specific elements */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        /* Style for a simple modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        /* Print styles for the report */
        @media print {
            body * {
                visibility: hidden;
            }
            #report-print-area, #report-print-area * {
                visibility: visible;
            }
            #report-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- 
      This is the main application container. 
      JavaScript will render the entire app inside this div.
    -->
    <div id="app-root" class="no-print"></div>
    
    <!-- 
      This container is used for all pop-up modals 
      (e.g., "Add Expense", "Mark as Paid").
    -->
    <div id="modal-container" class="no-print"></div>

    <!-- 
      This container is hidden and only used for printing the report.
    -->
    <div id="report-print-area" class="print-only"></div>

    <!-- 
      3. Load Firebase and Application Logic 
    -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut,
            signInAnonymously,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            deleteDoc,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // --- GLOBAL STATE & CONFIG ---

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyDllC4nXTDgtMMfw6CO0t92j820SOY7MPQ",
          authDomain: "my-budget-tracker-23b15.firebaseapp.com",
          databaseURL: "https://my-budget-tracker-23b15-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "my-budget-tracker-23b15",
          storageBucket: "my-budget-tracker-23b15.firebasestorage.app",
          messagingSenderId: "341614311933",
          appId: "1:341614311933:web:32b48db5576be8d7fb0194",
          measurementId: "G-44L5LDN7MW"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        // Get App ID from the config
        const appId = firebaseConfig.appId;

        // Main application state
        const state = {
            userId: null,
            isAuthReady: false,
            loading: true,
            view: 'tracker', // 'tracker', 'forecast', 'reports', 'settings'
            currentMonthYear: getCurrentMonthYear(), // e.g., "May 2025"
            userSettings: null, // Stores user settings (payouts, expense templates)
            currentBudget: null, // Stores the budget doc for the currentMonthYear
            editingExpense: { isEdit: false, id: null }, // For editing daily expenses
            // Firebase unsubscribe functions
            unsubSettings: () => {},
            unsubBudget: () => {},
        };

        // DOM elements
        const appRoot = document.getElementById('app-root');
        const modalContainer = document.getElementById('modal-container');
        const reportPrintArea = document.getElementById('report-print-area');

        // SVG Icons
        const icons = {
            home: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`,
            forecast: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>`,
            reports: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`,
            settings: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`,
            logout: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>`,
            plus: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`,
            edit: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`,
            chevronLeft: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>`,
            chevronRight: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`,
            calendar: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`,
            paid: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
        };

        // --- AUTH FUNCTIONS ---

        /**
         * Initiates Google Sign-In popup
         */
        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // Auth state change will be caught by onAuthStateChanged
            } catch (error) {
                console.error("Google Sign-In Error:", error);
            }
        }

        /**
         * Signs the user out
         */
        async function handleSignOut() {
            try {
                await signOut(auth);
                // Auth state change will be caught by onAuthStateChanged
                // It will clear state and re-render the login screen
            } catch (error) {
                console.error("Sign Out Error:", error);
            }
        }

        // --- DATABASE FUNCTIONS ---

        /**
         * Attaches real-time listeners to Settings and current Budget
         */
        function attachDataListeners() {
            if (!state.userId) return;

            // 1. Listen for User Settings
            const settingsDocPath = `artifacts/${appId}/users/${state.userId}/settings/userSettings`;
            const settingsRef = doc(db, settingsDocPath);

            state.unsubSettings = onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.userSettings = docSnap.data();
                } else {
                    // No settings found, create default ones
                    const defaultSettings = {
                        payout1: { label: "1st of Month", amount: 1500 },
                        payout2: { label: "15th of Month", amount: 1500 },
                        fixedExpenses: [], // { name, amount, dueDay }
                        semiMonthlyExpenses: [], // { name, amount, dueDay1, dueDay2 } - NEW
                    };
                    setDoc(settingsRef, defaultSettings);
                    state.userSettings = defaultSettings;
                }
                
                // 2. Once settings are loaded, listen for the current month's budget
                // Detach old budget listener before attaching a new one
                state.unsubBudget();
                setupBudgetListener();

            }, (error) => {
                console.error("Error listening to settings:", error);
                state.loading = false;
                renderApp();
            });
        }

        /**
         * Sets up the listener for the currently selected month's budget.
         * Creates a new budget doc if one doesn't exist.
         */
        function setupBudgetListener() {
            if (!state.userId || !state.userSettings) return;

            const budgetDocPath = `artifacts/${appId}/users/${state.userId}/budgets/${state.currentMonthYear}`;
            const budgetRef = doc(db, budgetDocPath);

            state.unsubBudget = onSnapshot(budgetRef, async (docSnap) => {
                if (docSnap.exists()) {
                    state.currentBudget = docSnap.data();
                } else {
                    // Budget for this month doesn't exist, create it
                    console.log(`Creating new budget for ${state.currentMonthYear}...`);
                    const newBudget = createNewMonthBudget();
                    await setDoc(budgetRef, newBudget);
                    state.currentBudget = newBudget; // Set state after creation
                }
                state.loading = false;
                renderApp(); // Render with the new budget data
            }, (error) => {
                console.error("Error listening to budget:", error);
                state.loading = false;
                renderApp();
            });
        }

        /**
         * Generates a new budget object based on user settings.
         * This is where the new logic for expenses is implemented.
         */
        function createNewMonthBudget() {
            const { payout1, payout2, fixedExpenses, semiMonthlyExpenses } = state.userSettings;
            
            const totalIncome = payout1.amount + payout2.amount;
            
            // Create fixed expenses list for the new budget
            const newFixedExpenses = (fixedExpenses || []).map(expense => ({
                id: crypto.randomUUID(), // Unique ID for each payable item
                name: expense.name,
                amount: expense.amount,
                dueDay: expense.dueDay,
                isPaid: false,
                paidOn: null,
                paidForMonth: "" // e.g., "May 2025"
            }));
            
            // Create semi-monthly expenses list
            const newSemiMonthlyExpenses = (semiMonthlyExpenses || []).flatMap(expense => {
                // Create two separate entries, one for each due day
                const entry1 = {
                    id: crypto.randomUUID(),
                    name: expense.name,
                    amount: expense.amount,
                    dueDay: expense.dueDay1,
                    isPaid: false,
                    paidOn: null,
                    paidForMonth: ""
                };
                const entry2 = {
                    id: crypto.randomUUID(),
                    name: expense.name,
                    amount: expense.amount,
                    dueDay: expense.dueDay2,
                    isPaid: false,
                    paidOn: null,
                    paidForMonth: ""
                };
                return [entry1, entry2];
            });

            return {
                monthYear: state.currentMonthYear,
                totalIncome: totalIncome,
                totalPaid: 0,
                totalDailyExpenses: 0,
                cashOnHand: totalIncome, // Starts with full income
                netIncome: totalIncome, // Starts with full income
                payouts: [
                    { ...payout1, isPaid: false },
                    { ...payout2, isPaid: false }
                ],
                fixedExpenses: newFixedExpenses,
                semiMonthlyExpenses: newSemiMonthlyExpenses,
                dailyExpenses: [], // { id, name, amount, date }
            };
        }

        /**
         * Saves the user's settings (from the Settings view)
         */
        async function saveSettings(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const newSettings = {
                payout1: {
                    label: formData.get('payout1-label'),
                    amount: parseFloat(formData.get('payout1-amount'))
                },
                payout2: {
                    label: formData.get('payout2-label'),
                    amount: parseFloat(formData.get('payout2-amount'))
                },
                fixedExpenses: [],
                semiMonthlyExpenses: []
            };

            // Process fixed expenses
            const fixedNames = formData.getAll('fixed-name');
            const fixedAmounts = formData.getAll('fixed-amount');
            const fixedDays = formData.getAll('fixed-day');
            for (let i = 0; i < fixedNames.length; i++) {
                if (fixedNames[i]) {
                    newSettings.fixedExpenses.push({
                        name: fixedNames[i],
                        amount: parseFloat(fixedAmounts[i]),
                        dueDay: parseInt(fixedDays[i])
                    });
                }
            }

            // Process semi-monthly expenses (NEW STRUCTURE)
            const semiNames = formData.getAll('semi-name');
            const semiAmounts = formData.getAll('semi-amount');
            const semiDay1s = formData.getAll('semi-day1');
            const semiDay2s = formData.getAll('semi-day2');
            for (let i = 0; i < semiNames.length; i++) {
                if (semiNames[i]) {
                    newSettings.semiMonthlyExpenses.push({
                        name: semiNames[i],
                        amount: parseFloat(semiAmounts[i]),
                        dueDay1: parseInt(semiDay1s[i]),
                        dueDay2: parseInt(semiDay2s[i])
                    });
                }
            }
            
            try {
                state.loading = true;
                renderApp();
                const settingsRef = doc(db, `artifacts/${appId}/users/${state.userId}/settings/userSettings`);
                await setDoc(settingsRef, newSettings);
                // Settings will refresh via onSnapshot
                // state.loading will be set to false by the listener
                logEvent(analytics, 'save_settings');
                // Show success feedback
                showToast("Settings saved successfully!");
            } catch (error) {
                console.error("Error saving settings: ", error);
                state.loading = false;
                renderApp();
                // Show error feedback
                showToast("Error saving settings.", "error");
            }
        }
        
        /**
         * Handles marking an income payout as paid.
         */
        async function markPayoutAsPaid(payoutIndex, paidDate) {
            if (!state.currentBudget) return;

            const updatedBudget = { ...state.currentBudget };
            updatedBudget.payouts[payoutIndex].isPaid = true;
            
            // This logic assumes `cashOnHand` and `netIncome` are calculated
            // based on expenses. Let's adjust this.
            // A better model: `totalIncome` is the *potential*.
            // `receivedIncome` is what's actually in-hand.
            // Let's create `receivedIncome` if it doesn't exist.
            
            const payoutAmount = updatedBudget.payouts[payoutIndex].amount;
            updatedBudget.receivedIncome = (updatedBudget.receivedIncome || 0) + payoutAmount;
            
            // Let's re-calculate `cashOnHand` and `netIncome` based on `receivedIncome`
            updatedBudget.cashOnHand = updatedBudget.receivedIncome - (updatedBudget.totalPaid || 0) - (updatedBudget.totalDailyExpenses || 0);
            updatedBudget.netIncome = updatedBudget.receivedIncome - (updatedBudget.totalPaid || 0) - (updatedBudget.totalDailyExpenses || 0);


            try {
                const budgetRef = doc(db, `artifacts/${appId}/users/${state.userId}/budgets/${state.currentMonthYear}`);
                await updateDoc(budgetRef, updatedBudget);
                logEvent(analytics, 'mark_income_paid');
                closeModal();
            } catch (error) {
                console.error("Error marking payout as paid:", error);
                showToast("Error updating payout.", "error");
            }
        }
        
        /**
         * REVISED: Handles submitting the "Add Daily/Unplanned Expense" modal.
         * Now supports both adding a new expense and editing an existing one.
         */
        async function handleSubmitDailyExpense() {
            const name = document.getElementById('daily-name').value;
            const amount = parseFloat(document.getElementById('daily-amount').value);
            const date = document.getElementById('daily-date').value;

            if (!name || isNaN(amount) || amount <= 0 || !date) {
                alert("Please fill in all fields with valid data.");
                return;
            }

            const currentBudget = { ...state.currentBudget };
            const { isEdit, id } = state.editingExpense;

            if (isEdit) {
                // --- EDIT LOGIC ---
                const expenseIndex = currentBudget.dailyExpenses.findIndex(e => e.id === id);
                if (expenseIndex === -1) {
                    console.error("Could not find expense to edit");
                    closeModal();
                    return;
                }
                
                const oldAmount = currentBudget.dailyExpenses[expenseIndex].amount;
                const amountDifference = amount - oldAmount;

                // Update the expense item
                currentBudget.dailyExpenses[expenseIndex] = { ...currentBudget.dailyExpenses[expenseIndex], name, amount, date };
                
                // Recalculate totals based on the *difference*
                currentBudget.totalDailyExpenses = currentBudget.totalDailyExpenses + amountDifference;
                currentBudget.cashOnHand = currentBudget.cashOnHand - amountDifference;
                currentBudget.netIncome = currentBudget.netIncome - amountDifference;

            } else {
                // --- ADD LOGIC ---
                const newExpense = {
                    id: crypto.randomUUID(), // Add unique ID
                    name,
                    amount,
                    date
                };
                
                currentBudget.dailyExpenses = [newExpense, ...currentBudget.dailyExpenses]; // Add to top of list
                
                // Recalculate totals
                currentBudget.totalDailyExpenses = (currentBudget.totalDailyExpenses || 0) + amount;
                currentBudget.cashOnHand = currentBudget.cashOnHand - amount;
                currentBudget.netIncome = currentBudget.netIncome - amount;
            }

            try {
                const budgetRef = doc(db, `artifacts/${appId}/users/${state.userId}/budgets/${state.currentMonthYear}`);
                await updateDoc(budgetRef, currentBudget);
                logEvent(analytics, isEdit ? 'edit_daily_expense' : 'add_daily_expense');
                closeModal();
            } catch (error) {
                console.error("Error saving daily expense:", error);
                showToast("Error saving expense.", "error");
            }
        }

        /**
         * NEW: Deletes a daily/unplanned expense.
         */
        async function handleDeleteDailyExpense(id) {
            const currentBudget = { ...state.currentBudget };
            const expenseIndex = currentBudget.dailyExpenses.findIndex(e => e.id === id);
            
            if (expenseIndex === -1) {
                console.error("Could not find expense to delete");
                closeModal();
                return;
            }

            const [removedExpense] = currentBudget.dailyExpenses.splice(expenseIndex, 1);
            const amount = removedExpense.amount;
            
            // Recalculate totals by *adding back* the amount
            currentBudget.totalDailyExpenses = currentBudget.totalDailyExpenses - amount;
            currentBudget.cashOnHand = currentBudget.cashOnHand + amount;
            currentBudget.netIncome = currentBudget.netIncome + amount;
            
            try {
                const budgetRef = doc(db, `artifacts/${appId}/users/${state.userId}/budgets/${state.currentMonthYear}`);
                await updateDoc(budgetRef, currentBudget);
                logEvent(analytics, 'delete_daily_expense');
                closeModal(); // Close the confirmation modal
            } catch (error) {
                console.error("Error deleting daily expense:", error);
                showToast("Error deleting expense.", "error");
            }
        }
        
        /**
         * NEW: Handles confirming payment for Fixed and Semi-Monthly expenses.
         */
        async function handleConfirmPayment(type, id) {
            const paidDate = document.getElementById('paid-date').value;
            const paidForMonth = document.getElementById('paid-for-month').value;
            
            if (!paidDate || !paidForMonth) {
                alert("Please fill in all fields.");
                return;
            }
            
            const currentBudget = { ...state.currentBudget };
            const expenseTypeKey = type === 'fixed' ? 'fixedExpenses' : 'semiMonthlyExpenses';
            
            const expenseIndex = currentBudget[expenseTypeKey].findIndex(e => e.id === id);
            if (expenseIndex === -1) {
                console.error("Could not find expense to mark as paid");
                closeModal();
                return;
            }
            
            const expense = currentBudget[expenseTypeKey][expenseIndex];
            
            // Prevent double payment
            if (expense.isPaid) {
                closeModal();
                return;
            }
            
            const amount = expense.amount;

            // Update the expense item
            expense.isPaid = true;
            expense.paidOn = paidDate;
            expense.paidForMonth = paidForMonth;
            
            // Recalculate totals
            currentBudget.totalPaid = (currentBudget.totalPaid || 0) + amount;
            currentBudget.cashOnHand = currentBudget.cashOnHand - amount;
            currentBudget.netIncome = currentBudget.netIncome - amount;
            
            try {
                const budgetRef = doc(db, `artifacts/${appId}/users/${state.userId}/budgets/${state.currentMonthYear}`);
                await updateDoc(budgetRef, currentBudget);
                logEvent(analytics, 'mark_expense_paid', { expense_type: type });
                closeModal();
            } catch (error) {
                console.error("Error marking expense as paid:", error);
                showToast("Error updating expense.", "error");
            }
        }


        // --- RENDER FUNCTIONS ---

        /**
         * Main render function. Called whenever state changes.
         */
        function renderApp() {
            if (state.loading) {
                appRoot.innerHTML = renderLoadingScreen();
                return;
            }
            
            if (!state.isAuthReady || !state.userId) {
                appRoot.innerHTML = renderLoginScreen();
                return;
            }

            // Main app layout
            appRoot.innerHTML = `
                <div class="flex flex-col md:flex-row min-h-screen bg-gray-100">
                    <!-- Mobile Nav (Bottom) -->
                    ${renderNavigation('mobile')}
                    
                    <!-- Desktop Nav (Side) -->
                    ${renderNavigation('desktop')}
                    
                    <!-- Main Content -->
                    <main class="flex-1 p-4 pb-24 md:pb-4 md:p-8 overflow-y-auto">
                        ${renderHeader()}
                        <div class="max-w-7xl mx-auto">
                            ${renderView()}
                        </div>
                    </main>
                </div>
            `;
            
            // Add event listeners after rendering
            attachEventListeners();
        }

        /**
         * Renders the current view based on state.view
         */
        function renderView() {
            switch (state.view) {
                case 'tracker':
                    return renderMonthlyTracker();
                case 'forecast':
                    return renderForecastView();
                case 'reports':
                    return renderReportsView();
                case 'settings':
                    return renderSettingsView();
                default:
                    return `<p>Unknown view: ${state.view}</p>`;
            }
        }
        
        /**
         * Renders the header with month navigation
         */
        function renderHeader() {
            if (state.view === 'settings') {
                return `<h1 class="text-3xl font-bold text-gray-800 mb-6">Settings</h1>`;
            }
            if (state.view === 'reports') {
                return `<h1 class="text-3xl font-bold text-gray-800 mb-6">Reports</h1>`;
            }
            if (state.view === 'forecast') {
                return `<h1 class="text-3xl font-bold text-gray-800 mb-6">Financial Forecast</h1>`;
            }
            
            // Tracker header
            return `
                <div class="flex items-center justify-between mb-6">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200 text-gray-600" title="Previous Month">
                        ${icons.chevronLeft}
                    </button>
                    <h1 class="text-3xl font-bold text-gray-800 text-center">
                        ${state.currentMonthYear}
                    </h1>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200 text-gray-600" title="Next Month">
                        ${icons.chevronRight}
                    </button>
                </div>
            `;
        }

        /**
         * Renders the main login screen
         */
        function renderLoginScreen() {
            return `
                <div class="flex items-center justify-center min-h-screen bg-gradient-to-br from-indigo-500 to-purple-600">
                    <div class="text-center bg-white p-10 rounded-2xl shadow-2xl max-w-sm mx-4">
                        <h1 class="text-4xl font-bold text-gray-800 mb-4">FinTrack</h1>
                        <p class="text-gray-600 mb-8">Your personal financial tracker.</p>
                        <button id="google-signin-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 ease-in-out flex items-center justify-center">
                            <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691L21.611 29.996L21.611 29.996C21.611 29.996 6.306 14.691 6.306 14.691zM6.306 14.691L11.963 19.348L11.963 19.348C16.618 24.003 24 24 24 24l-11.303 11.303L6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.192C30.01 34.668 27.139 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.023C9.505 39.556 16.227 44 24 44z"/><path fill="#1565C0" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.182 4.17-4.17 5.574l5.657 5.657C38.216 35.897 42 30.457 42 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                            Sign in with Google
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the loading spinner
         */
        function renderLoadingScreen() {
            return `
                <div class="flex items-center justify-center min-h-screen">
                    <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
            `;
        }
        
        /**
         * Renders the navigation bar (both mobile and desktop)
         */
        function renderNavigation(type) {
            const views = [
                { id: 'tracker', name: 'Tracker', icon: icons.home },
                { id: 'forecast', name: 'Forecast', icon: icons.forecast },
                { id: 'reports', name: 'Reports', icon: icons.reports },
                { id: 'settings', name: 'Settings', icon: icons.settings },
            ];
            
            const commonClasses = "flex items-center justify-center md:justify-start px-4 py-3 text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors duration-200";
            const activeClasses = "bg-indigo-100 text-indigo-700 font-bold";
            
            const links = views.map(view => `
                <a href="#" 
                   class="nav-link ${commonClasses} ${state.view === view.id ? activeClasses : ''}" 
                   data-view="${view.id}">
                    <span class="w-6 h-6">${view.icon}</span>
                    <span class="ml-0 md:ml-4 text-sm font-medium ${type === 'mobile' ? 'hidden' : 'md:block'}">${view.name}</span>
                </a>
            `).join('');

            if (type === 'mobile') {
                return `
                    <nav class="fixed bottom-0 left-0 right-0 z-10 md:hidden bg-white border-t border-gray-200 shadow-lg">
                        <div class="flex justify-around p-2">
                            ${links}
                        </div>
                    </nav>
                `;
            }
            
            if (type === 'desktop') {
                return `
                    <nav class="hidden md:flex flex-col w-64 p-4 pr-6 bg-white border-r border-gray-200 min-h-screen">
                        <div class="flex items-center mb-8">
                            <span class="text-3xl font-bold text-indigo-600">FinTrack</span>
                        </div>
                        <div class="flex-1 flex flex-col gap-2">
                            ${links}
                        </div>
                        <div class="mt-auto">
                            <button id="sign-out-btn" class="${commonClasses} w-full text-red-500 hover:bg-red-50 hover:text-red-600">
                                <span class="w-6 h-6">${icons.logout}</span>
                                <span class="ml-4 text-sm font-medium">Sign Out</span>
                            </button>
                        </div>
                    </nav>
                `;
            }
        }

        /**
         * Renders the main content for the Monthly Tracker view
         */
        function renderMonthlyTracker() {
            if (!state.currentBudget) {
                return `<p>Loading budget...</p>`;
            }

            const { 
                totalIncome, 
                totalPaid = 0, 
                totalDailyExpenses = 0, 
                cashOnHand = 0, 
                netIncome = 0, 
                payouts, 
                fixedExpenses, 
                semiMonthlyExpenses, 
                dailyExpenses 
            } = state.currentBudget;
            
            // Recalculate derived state, as the old budget doc might not have these
            const totalExpensesPaid = totalPaid + totalDailyExpenses;
            const actualCashOnHand = (state.currentBudget.receivedIncome || 0) - totalExpensesPaid;
            const actualNetIncome = (state.currentBudget.receivedIncome || 0) - totalExpensesPaid;

            return `
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-500">Total Income</h3>
                        <p class="text-3xl font-bold text-gray-800">${formatCurrency(totalIncome)}</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-500">Total Expenses Paid</h3>
                        <p class="text-3xl font-bold text-gray-800">${formatCurrency(totalExpensesPaid)}</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-500">Cash on Hand</h3>
                        <p class="text-3xl font-bold ${actualCashOnHand >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${formatCurrency(actualCashOnHand)}
                        </p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-500">Net Income</h3>
                        <p class="text-3xl font-bold ${actualNetIncome >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${formatCurrency(actualNetIncome)}
                        </p>
                    </div>
                </div>
                
                <!-- Main Content Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Left Column (Income & Fixed) -->
                    <div class="lg:col-span-1 flex flex-col gap-6">
                        ${renderIncomeCard(payouts)}
                        ${renderExpenseCard('Fixed Monthly Expenses', fixedExpenses, 'fixed')}
                    </div>
                    
                    <!-- Middle Column (Semi-Monthly) -->
                    <div class="lg:col-span-1 flex flex-col gap-6">
                        ${renderExpenseCard('Semi-Monthly Expenses', semiMonthlyExpenses, 'semiMonthly')}
                    </div>
                    
                    <!-- Right Column (Daily) -->
                    <div class="lg:col-span-1">
                        ${renderDailyExpenseCard(dailyExpenses, totalDailyExpenses)}
                    </div>
                    
                </div>
            `;
        }
        
        /**
         * Renders the Income card for the tracker
         */
        function renderIncomeCard(payouts) {
            const payoutItems = (payouts || []).map((payout, index) => `
                <li class="flex items-center justify-between py-3">
                    <div>
                        <p class="font-medium text-gray-800">${payout.label}</p>
                        <p class="text-xl font-semibold">${formatCurrency(payout.amount)}</p>
                    </div>
                    ${payout.isPaid
                        ? `<span class="flex items-center text-sm font-medium text-green-600 bg-green-100 px-3 py-1 rounded-full">
                               <span class="mr-1.5">${icons.paid}</span>
                               Paid
                           </span>`
                        : `<button class="payout-btn text-sm bg-blue-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-600 transition" data-index="${index}">
                               Mark as Paid
                           </button>`
                    }
                </li>
            `).join('');

            return `
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Income</h3>
                    <ul class="divide-y divide-gray-200">
                        ${payoutItems}
                    </ul>
                </div>
            `;
        }
        
        /**
         * Renders a generic expense card for Fixed and Semi-Monthly
         */
        function renderExpenseCard(title, expenses, type) {
            const expenseItems = (expenses || []).map(item => `
                <li class="flex items-center justify-between py-3">
                    <div>
                        <p class="font-medium text-gray-800">${item.name} (Day ${item.dueDay})</p>
                        <p class="text-xl font-semibold">${formatCurrency(item.amount)}</p>
                        ${item.isPaid 
                            ? `<span class="text-xs text-gray-500">Paid ${item.paidOn} (for ${item.paidForMonth})</span>` 
                            : ''
                        }
                    </div>
                    ${item.isPaid
                        ? `<span class="flex items-center text-sm font-medium text-green-600 bg-green-100 px-3 py-1 rounded-full">
                               <span class="mr-1.5">${icons.paid}</span>
                               Paid
                           </span>`
                        : `<button class="payment-btn text-sm bg-gray-700 text-white font-semibold px-4 py-2 rounded-lg hover:bg-gray-800 transition" 
                                   data-type="${type}" 
                                   data-id="${item.id}">
                               Mark as Paid
                           </button>`
                    }
                </li>
            `).join('');
            
            if (expenses.length === 0) {
                return `
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">${title}</h3>
                        <p class="text-gray-500 text-center py-4">No ${type} expenses configured. Go to Settings to add them.</p>
                    </div>
                `;
            }

            return `
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${title}</h3>
                    <ul class="divide-y divide-gray-200">
                        ${expenseItems}
                    </ul>
                </div>
            `;
        }
        
        /**
         * Renders the Daily & Unplanned Expenses card
         */
        function renderDailyExpenseCard(expenses, total) {
            const expenseItems = (expenses || []).map(item => `
                <li class="flex items-center justify-between py-3 group">
                    <div>
                        <p class="font-medium text-gray-800">${item.name}</p>
                        <p class="text-sm text-gray-500">${new Date(item.date + 'T00:00:00').toLocaleDateString()}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <p class="text-lg font-semibold text-red-600">${formatCurrency(item.amount)}</p>
                        <!-- Edit/Delete buttons (NEW) -->
                        <button class="edit-daily-btn p-1 text-gray-400 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity" 
                                title="Edit" 
                                data-id="${item.id}">
                            ${icons.edit}
                        </button>
                        <button class="delete-daily-btn p-1 text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" 
                                title="Delete" 
                                data-id="${item.id}">
                            ${icons.trash}
                        </button>
                    </div>
                </li>
            `).join('');

            return `
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Daily & Unplanned</h3>
                        <button id="add-daily-expense-btn" class="flex items-center bg-indigo-600 text-white font-semibold px-3 py-2 rounded-lg hover:bg-indigo-700 transition text-sm">
                            ${icons.plus}
                            <span class="ml-1.5">Add</span>
                        </button>
                    </div>
                    <div class="mb-4">
                        <p class="text-sm font-medium text-gray-500">Total Spent</p>
                        <p class="text-2xl font-bold text-red-600">${formatCurrency(total)}</p>
                    </div>
                    <ul class="divide-y divide-gray-200 max-h-96 overflow-y-auto pr-2">
                        ${expenses.length > 0 ? expenseItems : `<li class="text-gray-500 text-center py-4">No daily expenses logged yet.</li>`}
                    </ul>
                </div>
            `;
        }
        
        /**
         * Renders the Settings view
         */
        function renderSettingsView() {
            if (!state.userSettings) return `<p>Loading settings...</p>`;
            
            const { payout1, payout2, fixedExpenses, semiMonthlyExpenses } = state.userSettings;

            const fixedRows = (fixedExpenses || []).map((item, i) => `
                <div class="flex gap-2" data-row="fixed">
                    <input type="text" name="fixed-name" placeholder="Expense Name (e.g., Rent)" class="flex-1" value="${item.name}">
                    <input type="number" name="fixed-amount" placeholder="Amount" class="w-24" value="${item.amount}">
                    <input type="number" name="fixed-day" placeholder="Day" class="w-20" min="1" max="31" value="${item.dueDay}">
                    <button type="button" class="remove-row-btn text-red-500 p-2 rounded hover:bg-red-100">${icons.trash}</button>
                </div>
            `).join('');

            // NEW: Render rows for semi-monthly with two due dates
            const semiRows = (semiMonthlyExpenses || []).map((item, i) => `
                <div class="flex gap-2" data-row="semi">
                    <input type="text" name="semi-name" placeholder="Expense Name (e.g., Car)" class="flex-1" value="${item.name}">
                    <input type="number" name="semi-amount" placeholder="Amount" class="w-24" value="${item.amount}">
                    <input type="number" name="semi-day1" placeholder="Day 1" class="w-20" min="1" max="31" value="${item.dueDay1 || ''}">
                    <input type="number" name="semi-day2" placeholder="Day 2" class="w-20" min="1" max="31" value="${item.dueDay2 || ''}">
                    <button type="button" class="remove-row-btn text-red-500 p-2 rounded hover:bg-red-100">${icons.trash}</button>
                </div>
            `).join('');

            return `
                <form id="settings-form" class="max-w-4xl mx-auto space-y-8">
                    <!-- Common Input Styles -->
                    <style>
                        #settings-form input[type="text"],
                        #settings-form input[type="number"] {
                            display: block;
                            width: 100%;
                            padding: 0.75rem;
                            border: 1px solid #D1D5DB;
                            border-radius: 0.5rem;
                            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                            transition: border-color 0.2s, box-shadow 0.2s;
                        }
                        #settings-form input:focus {
                            outline: none;
                            border-color: #4F46E5;
                            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
                        }
                        .setting-card {
                            background-color: white;
                            padding: 1.5rem; /* p-6 */
                            border-radius: 1rem; /* rounded-2xl */
                            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
                            border: 1px solid #E5E7EB; /* border-gray-200 */
                        }
                    </style>
                
                    <!-- Payouts Section -->
                    <div class="setting-card">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Income / Payouts</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Payout 1 Label</label>
                                <input type="text" name="payout1-label" value="${payout1.label}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Payout 1 Est. Amount</label>
                                <input type="number" name="payout1-amount" value="${payout1.amount}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Payout 2 Label</label>
                                <input type="text" name="payout2-label" value="${payout2.label}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Payout 2 Est. Amount</label>
                                <input type="number" name="payout2-amount" value="${payout2.amount}">
                            </div>
                        </div>
                    </div>

                    <!-- Fixed Expenses -->
                    <div class="setting-card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Fixed Monthly Expenses</h3>
                            <button type="button" id="add-fixed-row" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition text-sm">Add Row</button>
                        </div>
                        <div id="fixed-rows-container" class="space-y-2">
                            ${fixedRows}
                        </div>
                    </div>

                    <!-- Semi-Monthly Expenses -->
                    <div class="setting-card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Semi-Monthly Expenses</h3>
                            <button type="button" id="add-semi-row" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition text-sm">Add Row</button>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">These expenses are paid twice a month (e.g., 1st and 15th). Enter the amount per payment.</p>
                        <div id="semi-rows-container" class="space-y-2">
                            ${semiRows}
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="flex justify-end">
                        <button type="submit" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition text-lg shadow-md">
                            Save Settings
                        </button>
                    </div>
                </form>
            `;
        }
        
        /**
         * Renders the Forecast view (placeholder)
         */
        function renderForecastView() {
            if (!state.userSettings || !state.currentBudget) return `<p>Loading data...</p>`;
            
            let forecastHtml = `<div class="space-y-6">`;
            let runningCash = state.currentBudget.cashOnHand;
            
            const { payout1, payout2, fixedExpenses, semiMonthlyExpenses } = state.userSettings;
            const totalMonthlyIncome = payout1.amount + payout2.amount;
            
            // Calculate total *template* expenses
            const totalFixed = (fixedExpenses || []).reduce((sum, item) => sum + item.amount, 0);
            // NEW: Semi-monthly template amount is per payment, so multiply by 2 for monthly total
            const totalSemi = (semiMonthlyExpenses || []).reduce((sum, item) => sum + (item.amount * 2), 0);
            
            const totalTemplateExpenses = totalFixed + totalSemi;
            const estimatedNet = totalMonthlyIncome - totalTemplateExpenses;

            for (let i = 0; i < 3; i++) {
                const forecastDate = new Date();
                forecastDate.setMonth(forecastDate.getMonth() + i);
                const monthYear = forecastDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                
                let startCash;
                if (i === 0) {
                    startCash = state.currentBudget.cashOnHand;
                } else {
                    startCash = runningCash + totalMonthlyIncome;
                }
                
                const endCash = startCash - totalTemplateExpenses;
                runningCash = endCash - totalTemplateExpenses; // This seems off, let's simplify
                
                if (i > 0) {
                     runningCash += totalMonthlyIncome - totalTemplateExpenses;
                } else {
                     runningCash = state.currentBudget.cashOnHand;
                }

                forecastHtml += `
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h3 class="text-2xl font-bold text-indigo-600 mb-4">${monthYear}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <p class="text-sm text-gray-500">Est. Starting Cash</p>
                                <p class="text-2xl font-semibold">${formatCurrency(runningCash)}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Est. Net Income</p>
                                <p class="text-2xl font-semibold ${estimatedNet >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(estimatedNet)}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Est. Ending Cash</p>
                                <p class="text-2xl font-bold ${runningCash + estimatedNet >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(runningCash + estimatedNet)}</p>
                            </div>
                        </div>
                    </div>
                `;
                runningCash += estimatedNet;
            }
            
            forecastHtml += `</div>`;
            return forecastHtml;
        }

        /**
         * Renders the Reports view
         */
        function renderReportsView() {
            // Get a list of available months to generate reports for
            // For now, just use the current month
            
            return `
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 max-w-2xl mx-auto">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Generate Report</h3>
                    <p class="text-gray-600 mb-6">Select a month to generate a printable report. This will use the data from your tracker.</p>
                    
                    <div class="flex gap-4 items-center">
                        <select id="report-month-select" class="flex-1 p-3 border border-gray-300 rounded-lg">
                            <option value="${state.currentMonthYear}">${state.currentMonthYear}</option>
                            <!-- In a real app, we'd query Firestore for all budget doc IDs -->
                        </select>
                        <button id="generate-report-btn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition">
                            Generate & Print
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Generates the HTML for the printable report
         */
        function generateReport() {
            if (!state.currentBudget) {
                showToast("No budget data to report.", "error");
                return;
            }
            
            const { 
                monthYear,
                totalIncome,
                totalPaid = 0,
                totalDailyExpenses = 0,
                receivedIncome = 0,
                fixedExpenses,
                semiMonthlyExpenses,
                dailyExpenses
            } = state.currentBudget;
            
            const totalExpensesPaid = totalPaid + totalDailyExpenses;
            const netIncome = receivedIncome - totalExpensesPaid;

            const renderSection = (title, items) => {
                if (!items || items.length === 0) return '';
                const rows = items.map(item => `
                    <tr class="border-b">
                        <td class="py-2 px-4">${item.name} ${item.date ? `(${new Date(item.date + 'T00:00:00').toLocaleDateString()})` : ''}</td>
                        <td class="py-2 px-4 text-right">${formatCurrency(item.amount)}</td>
                        <td class="py-2 px-4">${item.isPaid ? `Paid ${item.paidOn || ''}` : 'Unpaid'}</td>
                    </tr>
                `).join('');
                
                return `
                    <h3 class="text-xl font-semibold mt-6 mb-2">${title}</h3>
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b-2">
                                <th class="py-2 px-4">Item</th>
                                <th class="py-2 px-4 text-right">Amount</th>
                                <th class="py-2 px-4">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                `;
            };

            const reportHtml = `
                <div class="p-8 max-w-4xl mx-auto">
                    <h1 class="text-4xl font-bold mb-2">Financial Report</h1>
                    <h2 class="text-2xl text-gray-600 mb-8">${monthYear}</h2>
                    
                    <!-- Summary -->
                    <div class="grid grid-cols-3 gap-4 mb-8 text-center">
                        <div class="p-4 bg-gray-100 rounded-lg">
                            <p class="text-sm text-gray-500">Income Received</p>
                            <p class="text-2xl font-bold text-green-600">${formatCurrency(receivedIncome)}</p>
                        </div>
                        <div class="p-4 bg-gray-100 rounded-lg">
                            <p class="text-sm text-gray-500">Total Expenses Paid</p>
                            <p class="text-2xl font-bold text-red-600">${formatCurrency(totalExpensesPaid)}</p>
                        </div>
                        <div class="p-4 bg-gray-100 rounded-lg">
                            <p class="text-sm text-gray-500">Net Income</p>
                            <p class="text-2xl font-bold ${netIncome >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(netIncome)}</p>
                        </div>
                    </div>
                    
                    <!-- Details -->
                    ${renderSection('Fixed Expenses', fixedExpenses)}
                    ${renderSection('Semi-Monthly Expenses', semiMonthlyExpenses)}
                    ${renderSection('Daily & Unplanned Expenses', dailyExpenses)}
                </div>
            `;
            
            reportPrintArea.innerHTML = reportHtml;
            window.print();
        }


        // --- MODAL FUNCTIONS ---

        /**
         * Renders a generic modal
         */
        function renderModal(title, content) {
            modalContainer.innerHTML = `
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div classd="fixed inset-0 bg-black/50 modal-backdrop" id="modal-backdrop"></div>
                    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md z-10">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">${title}</h2>
                        <div>
                            ${content}
                        </div>
                    </div>
                </div>
            `;
            // Add click listener to backdrop to close
            document.getElementById('modal-backdrop').addEventListener('click', closeModal);
        }

        /**
         * Closes any open modal
         */
        function closeModal() {
            modalContainer.innerHTML = '';
        }
        
        /**
         * Shows the modal for marking an income payout as paid
         */
        function showPayoutModal(index) {
            const payout = state.currentBudget.payouts[index];
            const content = `
                <p class="text-lg mb-4">Mark <strong>${payout.label}</strong> (${formatCurrency(payout.amount)}) as paid?</p>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date Paid</label>
                    <input type="date" id="payout-date" class="w-full p-2 border border-gray-300 rounded-lg" value="${getTodayDate()}">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="text-gray-700 font-medium px-4 py-2 rounded-lg hover:bg-gray-100" onclick="closeModal()">Cancel</button>
                    <button type="button" id="confirm-payout-btn" class="bg-blue-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-blue-700">Confirm</button>
                </div>
            `;
            renderModal("Confirm Income", content);
            
            document.getElementById('confirm-payout-btn').onclick = () => {
                const paidDate = document.getElementById('payout-date').value;
                markPayoutAsPaid(index, paidDate);
            };
        }
        
        /**
         * NEW: Shows the modal for marking a fixed or semi-monthly expense as paid.
         */
        function showPaymentModal(type, id) {
            const expenseTypeKey = type === 'fixed' ? 'fixedExpenses' : 'semiMonthlyExpenses';
            const expense = state.currentBudget[expenseTypeKey].find(e => e.id === id);

            if (!expense) return;
            
            const content = `
                <p class="text-lg mb-4"><strong>${expense.name}</strong></p>
                <p class="text-3xl font-bold mb-6">${formatCurrency(expense.amount)}</p>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="paid-date">Date Paid</label>
                        <input type="date" id="paid-date" class="w-full p-2 border border-gray-300 rounded-lg" value="${getTodayDate()}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="paid-for-month">Month Paid For</label>
                        <input type="text" id="paid-for-month" class="w-full p-2 border border-gray-300 rounded-lg" value="${state.currentMonthYear}">
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-8">
                    <button type="button" class="text-gray-700 font-medium px-4 py-2 rounded-lg hover:bg-gray-100" onclick="closeModal()">Cancel</button>
                    <button type="button" id="confirm-payment-btn" class="bg-green-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-green-700">Mark as Paid</button>
                </div>
            `;
            renderModal(`Mark Expense as Paid`, content);
            
            document.getElementById('confirm-payment-btn').onclick = () => handleConfirmPayment(type, id);
        }

        /**
         * REVISED: Shows the modal for adding or editing a daily expense.
         */
        function showDailyExpenseModal(isEdit = false, id = null) {
            state.editingExpense = { isEdit, id };
            
            let name = '', amount = '', date = getTodayDate();
            let title = "Add Daily Expense";
            let buttonText = "Add Expense";
            
            if (isEdit) {
                const expense = state.currentBudget.dailyExpenses.find(e => e.id === id);
                if (expense) {
                    name = expense.name;
                    amount = expense.amount;
                    date = expense.date;
                    title = "Edit Expense";
                    buttonText = "Update Expense";
                }
            }

            const content = `
                <form id="daily-expense-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="daily-name">Expense Name</label>
                        <input type="text" id="daily-name" class="w-full p-2 border border-gray-300 rounded-lg" value="${name}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="daily-amount">Amount</label>
                        <input type="number" id="daily-amount" class="w-full p-2 border border-gray-300 rounded-lg" value="${amount}" step="0.01" min="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="daily-date">Date</label>
                        <input type="date" id="daily-date" class="w-full p-2 border border-gray-300 rounded-lg" value="${date}" required>
                    </div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" class="text-gray-700 font-medium px-4 py-2 rounded-lg hover:bg-gray-100" onclick="closeModal()">Cancel</button>
                        <button type="submit" id="submit-daily-expense" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-indigo-700">${buttonText}</button>
                    </div>
                </form>
            `;
            renderModal(title, content);
            
            // Handle form submission
            document.getElementById('daily-expense-form').onsubmit = (e) => {
                e.preventDefault();
                handleSubmitDailyExpense();
            };
        }
        
        /**
         * NEW: Shows a confirmation modal for deleting a daily expense
         */
        function confirmDeleteDailyExpense(id) {
            const expense = state.currentBudget.dailyExpenses.find(e => e.id === id);
            if (!expense) return;
            
            const content = `
                <p class="text-gray-700 mb-6">Are you sure you want to delete the expense:
                   <br><strong>"${expense.name}"</strong> (${formatCurrency(expense.amount)})?
                   <br><br>This action cannot be undone.
                </p>
                <div class="flex justify-end gap-3">
                    <button type="button" class="text-gray-700 font-medium px-4 py-2 rounded-lg hover:bg-gray-100" onclick="closeModal()">Cancel</button>
                    <button type="button" id="confirm-delete-btn" class="bg-red-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-red-700">Delete</button>
                </div>
            `;
            renderModal("Delete Expense?", content);
            
            document.getElementById('confirm-delete-btn').onclick = () => handleDeleteDailyExpense(id);
        }

        /**
         * Shows a temporary "toast" message
         */
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            toast.className = `fixed bottom-24 md:bottom-5 right-5 ${bgColor} text-white font-semibold py-3 px-6 rounded-lg shadow-lg transform translate-y-10 opacity-0 transition-all duration-300`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.transform = 'translate-y(0)';
                toast.style.opacity = '1';
            }, 100);
            
            // Animate out
            setTimeout(() => {
                toast.style.transform = 'translate-y(10px)';
                toast.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // --- EVENT LISTENERS ---

        /**
         * Attaches all global event listeners
         */
        function attachEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    state.view = e.currentTarget.dataset.view;
                    renderApp();
                });
            });

            // Sign Out
            const signOutBtn = document.getElementById('sign-out-btn');
            if (signOutBtn) {
                signOutBtn.addEventListener('click', handleSignOut);
            }
            
            // Month Navigation
            const prevMonthBtn = document.getElementById('prev-month-btn');
            if (prevMonthBtn) {
                prevMonthBtn.addEventListener('click', changeMonth);
            }
            const nextMonthBtn = document.getElementById('next-month-btn');
            if (nextMonthBtn) {
                nextMonthBtn.addEventListener('click', changeMonth);
            }
            
            // Tracker Page Buttons
            if (state.view === 'tracker') {
                document.querySelectorAll('.payout-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        showPayoutModal(parseInt(e.currentTarget.dataset.index));
                    });
                });
                
                // NEW: Payment buttons
                document.querySelectorAll('.payment-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const { type, id } = e.currentTarget.dataset;
                        showPaymentModal(type, id);
                    });
                });
                
                document.getElementById('add-daily-expense-btn').addEventListener('click', () => {
                    showDailyExpenseModal(false, null);
                });
                
                // NEW: Edit/Delete Daily Expense buttons
                document.querySelectorAll('.edit-daily-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        showDailyExpenseModal(true, e.currentTarget.dataset.id);
                    });
                });
                document.querySelectorAll('.delete-daily-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        confirmDeleteDailyExpense(e.currentTarget.dataset.id);
                    });
                });
            }
            
            // Settings Page
            if (state.view === 'settings') {
                document.getElementById('settings-form').addEventListener('submit', saveSettings);
                document.getElementById('add-fixed-row').addEventListener('click', () => addSettingsRow('fixed'));
                document.getElementById('add-semi-row').addEventListener('click', () => addSettingsRow('semi'));
                
                document.querySelectorAll('.remove-row-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.currentTarget.closest('div[data-row]').remove();
                    });
                });
            }
            
            // Reports Page
            if (state.view === 'reports') {
                document.getElementById('generate-report-btn').addEventListener('click', generateReport);
            }
        }
        
        /**
         * Handles clicks on global elements (delegation)
         * This is a useful pattern, but for this app, specific listeners
         * in attachEventListeners() is clearer.
         */
         // We can expose functions to the window scope to be called from onclick attributes
         window.closeModal = closeModal;
         window.handleConfirmPayment = handleConfirmPayment;
         window.handleSubmitDailyExpense = handleSubmitDailyExpense;
         window.showDailyExpenseModal = showDailyExpenseModal;
         window.handleDeleteDailyExpense = handleDeleteDailyExpense;
         window.confirmDeleteDailyExpense = confirmDeleteDailyExpense;


        // --- UTILITY FUNCTIONS ---

        /**
         * Formats a number as USD currency
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        /**
         * Gets the current month and year as a string (e.g., "May 2025")
         */
        function getCurrentMonthYear() {
            return new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
        }
        
        /**
         * Gets today's date in YYYY-MM-DD format
         */
        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }
        
        /**
         * Changes the current month view (prev or next)
         */
        function changeMonth(e) {
            const currentMonthDate = new Date(state.currentMonthYear);
            let newMonth;
            
            if (e.currentTarget.id === 'prev-month-btn') {
                newMonth = currentMonthDate.setMonth(currentMonthDate.getMonth() - 1);
            } else {
                newMonth = currentMonthDate.setMonth(currentMonthDate.getMonth() + 1);
            }
            
            state.currentMonthYear = new Date(newMonth).toLocaleString('default', { month: 'long', year: 'numeric' });
            
            // Update state
            state.loading = true;
            state.currentBudget = null; // Clear old budget
            
            // Detach old listener and attach new one
            state.unsubBudget();
            setupBudgetListener();
            
            // Re-render to show loading spinner
            renderApp();
        }
        
        /**
         * Adds a new row to the Settings form
         */
        function addSettingsRow(type) {
            const container = document.getElementById(`${type}-rows-container`);
            const div = document.createElement('div');
            div.className = 'flex gap-2';
            div.dataset.row = type;
            
            if (type === 'fixed') {
                div.innerHTML = `
                    <input type="text" name="fixed-name" placeholder="Expense Name (e.g., Rent)" class="flex-1">
                    <input type="number" name="fixed-amount" placeholder="Amount" class="w-24">
                    <input type="number" name="fixed-day" placeholder="Day" class="w-20" min="1" max="31">
                    <button type="button" class="remove-row-btn text-red-500 p-2 rounded hover:bg-red-100">${icons.trash}</button>
                `;
            } else { // semi
                div.innerHTML = `
                    <input type="text" name="semi-name" placeholder="Expense Name (e.g., Car)" class="flex-1">
                    <input type="number" name="semi-amount" placeholder="Amount" class="w-24">
                    <input type="number" name="semi-day1" placeholder="Day 1" class="w-20" min="1" max="31">
                    <input type="number" name="semi-day2" placeholder="Day 2" class="w-20" min="1" max="31">
                    <button type="button" class="remove-row-btn text-red-500 p-2 rounded hover:bg-red-100">${icons.trash}</button>
                `;
            }
            
            // Add remove event listener to the new button
            div.querySelector('.remove-row-btn').addEventListener('click', (e) => {
                e.currentTarget.closest('div[data-row]').remove();
            });
            
            container.appendChild(div);
        }

        // --- INITIALIZATION ---

        /**
         * Main function to start the app
         */
        async function main() {
            try {
                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in!
                        state.userId = user.uid;
                        state.isAuthReady = true;
                        state.loading = true; // Set to loading while we fetch data
                        
                        // Detach any old listeners before attaching new ones
                        state.unsubSettings();
                        state.unsubBudget();
                        
                        attachDataListeners(); // This will fetch data and render the app
                        
                    } else {
                        // User is signed out!
                        state.userId = null;
                        state.isAuthReady = false;
                        state.loading = false;
                        
                        // Detach listeners
                        state.unsubSettings();
                        state.unsubBudget();

                        renderApp(); // This will call renderLoginScreen()
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                appRoot.innerHTML = `<div class="p-8 text-center text-red-600 no-print">
                    <h2 class="text-2xl font-bold">Error connecting to database</h2>
                    <p class=mt-2>Could not initialize Firebase. Please check your console and Firebase configuration.</p>
                </div>`;
            }
        }
        
        // Start the application
        main();

    </script>
</body>
</html>
