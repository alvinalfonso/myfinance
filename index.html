<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Financial Tracker</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 2. Set default font to match the app */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for animations or specific elements */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        /* Style for a simple modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        /* Print styles for the report */
        @media print {
            body * {
                visibility: hidden;
            }
            #report-print-area, #report-print-area * {
                visibility: visible;
            }
            #report-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
        
        /* Custom button styles for better visibility */
        .btn {
            @apply text-sm px-3 py-1.5 rounded-lg shadow-sm transition-all duration-150;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 hover:bg-gray-300;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700;
        }
        .btn-success {
             @apply bg-green-600 text-white hover:bg-green-700;
        }
        .btn-warning {
            @apply bg-yellow-500 text-gray-900 hover:bg-yellow-600;
        }
        
        /* Ensure inputs are consistent */
        .form-input {
            @apply w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .form-select {
             @apply w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white;
        }
        
        /* Card styles */
        .card {
            @apply bg-white shadow-lg rounded-xl p-6;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Main Application Root -->
    <div id="app-root">
        <!-- App content will be rendered here by JavaScript -->
    </div>

    <!-- 
      MODALS SECTION
      These are hidden by default and shown by JavaScript.
    -->
    
    <!-- Edit Expense Modal (for Daily/Unplanned) -->
    <div id="edit-expense-modal" class="no-print modal-backdrop fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="card w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Edit Expense</h2>
            <form id="edit-expense-form">
                <input type="hidden" id="edit-expense-id">
                <input type="hidden" id="edit-expense-type">
                <input type="hidden" id="edit-expense-month">
                
                <div class="mb-4">
                    <label for="edit-expense-name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="edit-expense-name" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="edit-expense-amount" class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                    <input type="number" id="edit-expense-amount" step="0.01" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="edit-expense-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input type="date" id="edit-expense-date" class="form-input" required>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-edit-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirm Deletion Modal -->
    <div id="confirm-delete-modal" class="no-print modal-backdrop fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="card w-full max-w-sm">
            <h2 class="text-xl font-bold mb-2">Are you sure?</h2>
            <p class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancel-delete-btn" class="btn btn-secondary">Cancel</button>
                <button type="button" id="confirm-delete-btn" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- 
      END MODALS SECTION
    -->


    <!-- 3. Load Firebase Services -->
    <script type="module">
        // Firebase and Firestore imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, // Keeping the import just in case, but not using it for the button
            signInWithCustomToken, 
            onAuthStateChanged,
            GoogleAuthProvider, // <-- ADDED
            signInWithPopup     // <-- ADDED
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE ---
        // This object holds all our application's data
        const state = {
            app: null,
            db: null,
            auth: null,
            userId: null,
            isAuthReady: false, // Becomes true after auth state is confirmed
            loading: true, // True while app is booting
            
            // Firestore data listeners
            unsubSettings: () => {}, // Function to unsubscribe from settings listener
            unsubBudget: () => {},   // Function to unsubscribe from budget listener

            // App Data
            settings: {
                username: "User",
                currency: "USD",
            },
            budget: {
                // Stores income by month, e.g., "2025-11": 3000
                income: {}, 
                // Stores all expense *templates*
                expenses: {
                    monthly: [], // { id, name, amount, category, dayOfMonth, payments: {"2025-11": {paidOn, amount}} }
                    semiMonthly: [], // { id, name, amount, category, dayOfMonth1, dayOfMonth2, payments: {"2025-11-1": {paidOn, amount}} }
                    daily: {}, // e.g., "2025-11": [ { id, name, amount, category, date } ]
                    unplanned: {} // e.g., "2025-11": [ { id, name, amount, category, date } ]
                }
            },
            
            // UI State
            currentView: "dashboard", // 'dashboard', 'expenses', 'report', 'settings'
            currentDate: new Date(),
            
            get currentYearMonth() {
                // Returns "YYYY-MM" format
                return this.currentDate.toISOString().slice(0, 7);
            }
        };

        // --- DOM ELEMENTS ---
        const appRoot = document.getElementById("app-root");
        const editExpenseModal = document.getElementById("edit-expense-modal");
        const confirmDeleteModal = document.getElementById("confirm-delete-modal");

        // --- UTILITY FUNCTIONS ---
        
        /**
         * Formats a number as a currency string.
         */
        function formatCurrency(amount, currency = state.settings.currency) {
            try {
                return new Intl.NumberFormat(undefined, {
                    style: "currency",
                    currency: currency,
                    minimumFractionDigits: 2,
                }).format(amount);
            } catch (error) {
                // Fallback for invalid currency
                console.warn("Invalid currency code:", currency, "falling back to USD.");
                return new Intl.NumberFormat(undefined, {
                    style: "currency",
                    currency: "USD",
                    minimumFractionDigits: 2,
                }).format(amount);
            }
        }
        
        /**
         * Gets the current "YYYY-MM" string.
         */
        function getCurrentYearMonth() {
            return state.currentDate.toISOString().slice(0, 7);
        }
        
        /**
         * Gets the month and year as a string, e.g., "November 2025"
         */
        function getMonthYearString(date) {
            return date.toLocaleString('default', { month: 'long', year: 'numeric' });
        }
        
        /**
         * Debounce function to limit rapid calls
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }


        // --- FIRESTORE FUNCTIONS ---

        /**
         * Saves the current settings object to Firestore.
         */
        async function saveSettings() {
            if (!state.userId) return;
            const settingsRef = doc(state.db, "users", state.userId, "app", "settings");
            try {
                await setDoc(settingsRef, state.settings);
                console.log("Settings saved.");
            } catch (error)
            {
                console.error("Error saving settings:", error);
            }
        }
        
        /**
         * Saves the current budget object to Firestore.
         * Debounced to prevent rapid writes.
         */
        const saveBudget = debounce(async () => {
            if (!state.userId) return;
            const budgetRef = doc(state.db, "users", state.userId, "app", "budget");
            try {
                // We save the entire budget object
                await setDoc(budgetRef, state.budget);
                console.log("Budget saved.");
            } catch (error)
            {
                console.error("Error saving budget:", error);
            }
        }, 1500); // Wait 1.5s after the last change to save


        /**
         * Attaches realtime listeners to Firestore data.
         */
        function attachDataListeners() {
            if (!state.userId) return;

            // Detach old listeners first
            state.unsubSettings();
            state.unsubBudget();

            // --- Settings Listener ---
            const settingsRef = doc(state.db, "users", state.userId, "app", "settings");
            state.unsubSettings = onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.settings = docSnap.data();
                } else {
                    // No settings, save the defaults
                    saveSettings();
                }
                // Update loading state and render
                state.loading = false;
                renderApp();
            }, (error) => {
                console.error("Error fetching settings:", error);
                state.loading = false;
                renderApp();
            });

            // --- Budget Listener ---
            const budgetRef = doc(state.db, "users", state.userId, "app", "budget");
            state.unsubBudget = onSnapshot(budgetRef, (docSnap) => {
                if (docSnap.exists()) {
                    const budgetData = docSnap.data();
                    // Ensure all keys exist to prevent errors
                    state.budget = {
                        income: budgetData.income || {},
                        expenses: {
                            monthly: budgetData.expenses?.monthly || [],
                            semiMonthly: budgetData.expenses?.semiMonthly || [],
                            daily: budgetData.expenses?.daily || {},
                            unplanned: budgetData.expenses?.unplanned || {}
                        }
                    };
                } else {
                    // No budget, create a default one
                    const initialBudget = {
                        income: { [getCurrentYearMonth()]: 0 },
                        expenses: {
                            monthly: [],
                            semiMonthly: [],
                            daily: { [getCurrentYearMonth()]: [] },
                            unplanned: { [getCurrentYearMonth()]: [] }
                        }
                    };
                    state.budget = initialBudget;
                    // Save this initial budget
                    saveBudget();
                }
                // Update loading state and render
                state.loading = false;
                renderApp();
            }, (error) => {
                console.error("Error fetching budget:", error);
                state.loading = false;
                renderApp();
            });
        }
        
        
        // --- DATA CALCULATION ---
        
        /**
         * Calculates all dashboard stats for the current month.
         */
        function calculateCurrentMonthStats() {
            const yearMonth = getCurrentYearMonth();
            const income = state.budget.income[yearMonth] || 0;
            
            let totalPaid = 0; // Total of *paid* monthly/semi-monthly bills
            let totalPending = 0; // Total of *unpaid* monthly/semi-monthly bills
            
            // 1. Calculate Monthly Bill Payments
            state.budget.expenses.monthly.forEach(expense => {
                const paymentKey = yearMonth;
                const payment = (expense.payments && expense.payments[paymentKey]) ? expense.payments[paymentKey] : null;
                
                if (payment) {
                    totalPaid += payment.amount;
                } else {
                    totalPending += expense.amount;
                }
            });
            
            // 2. Calculate Semi-Monthly Bill Payments
            state.budget.expenses.semiMonthly.forEach(expense => {
                const paymentKey1 = `${yearMonth}-1`;
                const paymentKey2 = `${yearMonth}-2`;
                
                const payment1 = (expense.payments && expense.payments[paymentKey1]) ? expense.payments[paymentKey1] : null;
                const payment2 = (expense.payments && expense.payments[paymentKey2]) ? expense.payments[paymentKey2] : null;

                if (payment1) {
                    totalPaid += payment1.amount;
                } else {
                    totalPending += expense.amount; // `amount` is per-payment
                }
                
                if (payment2) {
                    totalPaid += payment2.amount;
                } else {
                    totalPending += expense.amount; // `amount` is per-payment
                }
            });
            
            // 3. Calculate Daily Expenses
            const dailyExpenses = state.budget.expenses.daily[yearMonth] || [];
            const totalDaily = dailyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            
            // 4. Calculate Unplanned Expenses
            const unplannedExpenses = state.budget.expenses.unplanned[yearMonth] || [];
            const totalUnplanned = unplannedExpenses.reduce((sum, exp) => sum + exp.amount, 0);

            // Total spent is paid bills + daily + unplanned
            const totalExpenses = totalPaid + totalDaily + totalUnplanned;
            const remainingBalance = income - totalExpenses;
            
            return {
                income,
                totalExpenses,
                remainingBalance,
                totalPaid, // Paid bills
                totalPending, // Unpaid bills
                totalDaily,
                totalUnplanned,
                currency: state.settings.currency
            };
        }


        // --- RENDER FUNCTIONS ---

        /**
         * Main render function for the entire application.
         */
        function renderApp() {
            if (state.loading) {
                appRoot.innerHTML = renderLoadingScreen();
                return;
            }
            
            if (!state.userId) {
                appRoot.innerHTML = renderLoginScreen();
                return;
            }

            // Main app structure
            appRoot.innerHTML = `
                <div classclass="min-h-screen flex flex-col lg:flex-row">
                    <!-- Navigation -->
                    ${renderNavigation()}
                    
                    <!-- Main Content -->
                    <main class="flex-1 p-4 sm:p-6 lg:p-8">
                        ${renderCurrentView()}
                    </main>
                </div>
            `;
            
            // Add event listeners for the rendered content
            addAppEventListeners();
        }
        
        /**
         * Renders the current view based on state.currentView.
         */
        function renderCurrentView() {
            switch (state.currentView) {
                case 'dashboard':
                    return renderDashboard();
                case 'expenses':
                    return renderExpenses();
                case 'report':
                    return renderReport();
                case 'settings':
                    return renderSettings();
                default:
                    return renderDashboard();
            }
        }
        
        /**
         * Renders a loading spinner.
         */
        function renderLoadingScreen() {
            return `
                <div class="flex items-center justify-center min-h-screen">
                    <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
            `;
        }
        
        /**
         * Renders the login UI (which is just a button for anonymous login).
         */
        function renderLoginScreen() {
            return `
                <div class="flex items-center justify-center min-h-screen bg-gray-100">
                    <div class="card text-center shadow-xl p-8">
                        <h1 class="text-3xl font-bold text-gray-800 mb-4">Welcome</h1>
                        <p class="text-gray-600 mb-8">Sign in with Google to track your finances.</p>
                        <button id="google-login-btn" class="flex items-center justify-center gap-2 btn bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 w-full text-lg py-2">
                            <svg class="w-6 h-6" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.73-2.99-.73-4.59s.25-3.14.73-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.8l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                            Sign In with Google
                        </button>
                    </div>
                </div>
            `;
        }
        
        /**
         * Renders the main navigation bar.
         */
        function renderNavigation() {
            const getLinkClass = (view) => 
                state.currentView === view
                    ? 'bg-blue-600 text-white'
                    : 'text-gray-700 hover:bg-gray-200';
            
            return `
                <nav class="no-print bg-white shadow-lg w-full lg:w-64">
                    <div class="p-6">
                        <h1 class="text-2xl font-bold text-blue-600">FinTracker</h1>
                    </div>
                    <ul class="space-y-2 p-4">
                        <li>
                            <button data-view="dashboard" class="nav-link w-full text-left px-4 py-2 rounded-lg ${getLinkClass('dashboard')}">
                                Dashboard
                            </button>
                        </li>
                        <li>
                            <button data-view="expenses" class="nav-link w-full text-left px-4 py-2 rounded-lg ${getLinkClass('expenses')}">
                                Expenses
                            </button>
                        </li>
                        <li>
                            <button data-view="report" class="nav-link w-full text-left px-4 py-2 rounded-lg ${getLinkClass('report')}">
                                Report
                            </button>
                        </li>
                        <li>
                            <button data-view="settings" class="nav-link w-full text-left px-4 py-2 rounded-lg ${getLinkClass('settings')}">
                                Settings
                            </button>
                        </li>
                    </ul>
                </nav>
            `;
        }
        
        /**
         * Renders the Dashboard view.
         */
        function renderDashboard() {
            const stats = calculateCurrentMonthStats();
            const yearMonth = getCurrentYearMonth();
            const currentIncome = state.budget.income[yearMonth] || 0;
            
            return `
                <div class="max-w-7xl mx-auto">
                    <!-- Header -->
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">
                            Dashboard for ${getMonthYearString(state.currentDate)}
                        </h1>
                        <div class="flex gap-2 mt-4 sm:mt-0">
                            <button id="prev-month-btn" class="btn btn-secondary">&lt; Prev</button>
                            <button id="next-month-btn" class="btn btn-secondary">Next &gt;</button>
                        </div>
                    </div>
                    
                    <!-- Income Card -->
                    <div class="card mb-6">
                        <h2 class="text-xl font-semibold mb-3">Monthly Income</h2>
                        <div class="flex items-center gap-4">
                            <span class="text-3xl font-bold text-gray-700">${formatCurrency(currentIncome)}</span>
                            <button id="edit-income-btn" class="btn btn-secondary">Edit</button>
                        </div>
                        <div id="edit-income-form" class="mt-4 hidden">
                            <label for="income-input" class="text-sm text-gray-600">Set income for ${getMonthYearString(state.currentDate)}</label>
                            <div class="flex gap-2 mt-1">
                                <input type="number" id="income-input" class="form-input w-48" value="${currentIncome}" step="100">
                                <button id="save-income-btn" class="btn btn-primary">Save</button>
                                <button id="cancel-income-btn" class="btn btn-secondary">Cancel</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="card bg-green-500 text-white">
                            <h3 class="text-lg font-medium opacity-90">Remaining Balance</h3>
                            <p class="text-4xl font-bold">${formatCurrency(stats.remainingBalance)}</p>
                        </div>
                        <div class="card bg-red-500 text-white">
                            <h3 class="text-lg font-medium opacity-90">Total Spent</h3>
                            <p class="text-4xl font-bold">${formatCurrency(stats.totalExpenses)}</p>
                        </div>
                        <div class="card bg-yellow-400 text-gray-900">
                            <h3 class="text-lg font-medium opacity-90">Pending Bills</h3>
                            <p class="text-4xl font-bold">${formatCurrency(stats.totalPending)}</p>
                        </div>
                        
                        <div class="card col-span-1 md:col-span-2 lg:col-span-3">
                            <h3 class="text-xl font-semibold mb-4">Expense Breakdown</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <h4 class="text-sm font-medium text-gray-500">Paid Bills</h4>
                                    <p class="text-2xl font-semibold text-gray-800">${formatCurrency(stats.totalPaid)}</p>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <h4 class="text-sm font-medium text-gray-500">Daily Expenses</h4>
                                    <p class="text-2xl font-semibold text-gray-800">${formatCurrency(stats.totalDaily)}</p>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <h4 class="text-sm font-medium text-gray-500">Unplanned</h4>
                                    <p class="text-2xl font-semibold text-gray-800">${formatCurrency(stats.totalUnplanned)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Renders the main Expenses view (forms and lists).
         */
        function renderExpenses() {
            return `
                <div class="max-w-7xl mx-auto">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Expenses</h1>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Left Column: Add Expense Form -->
                        <div class="lg:col-span-1">
                            ${renderAddExpenseForm()}
                        </div>
                        
                        <!-- Right Column: Expense Lists -->
                        <div class="lg:col-span-2 space-y-8">
                            ${renderMonthlyExpenses()}
                            ${renderSemiMonthlyExpenses()}
                            ${renderDailyExpenses()}
                            ${renderUnplannedExpenses()}
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Renders the "Add Expense" form.
         */
        function renderAddExpenseForm() {
            // This HTML will be swapped out based on the dropdown
            const formFields = `
                <div id="dayOfMonthInput" class="hidden">
                    <label for="expense-day" class="block text-sm font-medium text-gray-700 mb-1">Day of Month</label>
                    <input type="number" id="expense-day" class="form-input" min="1" max="31">
                </div>
                
                <!-- REVISION: Added two date fields for semi-monthly -->
                <div id="semiMonthlyInputs" class="hidden space-y-3">
                    <div>
                        <label for="expense-day-1" class="block text-sm font-medium text-gray-700 mb-1">First Due Date (Day)</label>
                        <input type="number" id="expense-day-1" class="form-input" min="1" max="31">
                    </div>
                    <div>
                        <label for="expense-day-2" class="block text-sm font-medium text-gray-700 mb-1">Second Due Date (Day)</label>
                        <input type="number" id="expense-day-2" class="form-input" min="1" max="31">
                    </div>
                </div>
                
                <div id="dateInput" class="hidden">
                    <label for="expense-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input type="date" id="expense-date" class="form-input">
                </div>
            `;
            
            return `
                <div class="card sticky top-8">
                    <h2 class="text-xl font-bold mb-4">Add New Expense</h2>
                    <form id="add-expense-form" class="space-y-4">
                        <div>
                            <label for="expense-name" class="block text-sm font-medium text-gray-700 mb-1">Expense Name</label>
                            <input type="text" id="expense-name" class="form-input" required>
                        </div>
                        <div>
                            <label for="expense-amount" class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                            <input type="number" id="expense-amount" class="form-input" step="0.01" required>
                        </div>
                        <div>
                            <label for="expense-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <input type="text" id="expense-category" class="form-input" required>
                        </div>
                        <div>
                            <label for="expense-type" class="block text-sm font-medium text-gray-700 mb-1">Expense Type</label>
                            <select id="expense-type" class="form-select">
                                <option value="daily">Daily</option>
                                <option value="unplanned">Unplanned</option>
                                <option value="monthly">Monthly Bill</option>
                                <option value="semiMonthly">Semi-Monthly Bill</option>
                            </select>
                        </div>
                        
                        <div id="expense-type-fields">
                            ${formFields}
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-full py-2.5">Add Expense</button>
                    </form>
                </div>
            `;
        }
        
        /**
         * Renders the list of MONTHLY expenses.
         * REVISION: Shows payment status and "Mark as Paid" button.
         */
        function renderMonthlyExpenses() {
            const monthlyExpenses = state.budget.expenses.monthly || [];
            const yearMonth = getCurrentYearMonth();
            
            const expenseItems = monthlyExpenses.map(expense => {
                const paymentKey = yearMonth;
                // Ensure payments object exists before accessing
                const payment = (expense.payments && expense.payments[paymentKey]) ? expense.payments[paymentKey] : null;
                
                let paymentStatusHTML = '';
                if (payment) {
                    paymentStatusHTML = `
                        <div class="text-sm text-green-700 font-medium">
                            Paid on ${new Date(payment.paidOn).toLocaleDateString()}
                        </div>
                    `;
                } else {
                    paymentStatusHTML = `
                        <button class="btn btn-success btn-sm mark-as-paid-btn" 
                                data-id="${expense.id}" 
                                data-type="monthly" 
                                data-key="${paymentKey}" 
                                data-amount="${expense.amount}">
                            Mark as Paid
                        </button>
                    `;
                }
                
                return `
                    <li class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-3 px-4 rounded-lg bg-gray-50 hover:bg-gray-100">
                        <div class="flex-1 mb-2 sm:mb-0">
                            <span class="font-medium text-gray-800">${expense.name}</span>
                            <span class="block sm:inline sm:ml-2 text-sm text-gray-500">
                                ${expense.category} - Due on day ${expense.dayOfMonth}
                            </span>
                        </div>
                        <div class="flex items-center gap-4 w-full sm:w-auto">
                             <span class="font-semibold text-lg text-gray-800">${formatCurrency(expense.amount)}</span>
                             ${paymentStatusHTML}
                        </div>
                    </li>
                `;
            }).join('');
            
            return `
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Monthly Bills</h2>
                    ${monthlyExpenses.length > 0 
                        ? `<ul class="space-y-2">${expenseItems}</ul>` 
                        : `<p class="text-gray-500">No monthly bills added yet.</p>`
                    }
                </div>
            `;
        }
        
        /**
         * Renders the list of SEMI-MONTHLY expenses.
         * REVISION: Shows two due dates and two payment statuses.
         */
        function renderSemiMonthlyExpenses() {
            const semiMonthlyExpenses = state.budget.expenses.semiMonthly || [];
            const yearMonth = getCurrentYearMonth();

            const expenseItems = semiMonthlyExpenses.map(expense => {
                // Payment 1
                const paymentKey1 = `${yearMonth}-1`;
                const payment1 = (expense.payments && expense.payments[paymentKey1]) ? expense.payments[paymentKey1] : null;
                let paymentStatus1HTML = '';
                if (payment1) {
                    paymentStatus1HTML = `<span class="text-xs text-green-700 font-medium">Paid ${new Date(payment1.paidOn).toLocaleDateString()}</span>`;
                } else {
                    paymentStatus1HTML = `
                        <button class="btn btn-success btn-sm mark-as-paid-btn" 
                                data-id="${expense.id}" 
                                data-type="semiMonthly" 
                                data-key="${paymentKey1}" 
                                data-amount="${expense.amount}">
                            Pay
                        </button>`;
                }
                
                // Payment 2
                const paymentKey2 = `${yearMonth}-2`;
                const payment2 = (expense.payments && expense.payments[paymentKey2]) ? expense.payments[paymentKey2] : null;
                let paymentStatus2HTML = '';
                if (payment2) {
                    paymentStatus2HTML = `<span class="text-xs text-green-700 font-medium">Paid ${new Date(payment2.paidOn).toLocaleDateString()}</span>`;
                } else {
                    paymentStatus2HTML = `
                        <button class="btn btn-success btn-sm mark-as-paid-btn" 
                                data-id="${expense.id}" 
                                data-type="semiMonthly" 
                                data-key="${paymentKey2}" 
                                data-amount="${expense.amount}">
                            Pay
                        </button>`;
                }

                return `
                    <li class="py-3 px-4 rounded-lg bg-gray-50 hover:bg-gray-100">
                        <div class="flex justify-between items-center mb-2">
                             <div>
                                <span class="font-medium text-gray-800">${expense.name}</span>
                                <span class="block sm:inline sm:ml-2 text-sm text-gray-500">${expense.category}</span>
                            </div>
                            <span class="font-semibold text-lg text-gray-800">${formatCurrency(expense.amount)} <span class="text-sm font-normal text-gray-500">(per payment)</span></span>
                        </div>
                        <div class="flex justify-between items-center gap-4 text-sm bg-white p-2 rounded">
                            <div class="flex-1">
                                <span class="text-gray-600">Due on day ${expense.dayOfMonth1}</span>
                            </div>
                            ${paymentStatus1HTML}
                        </div>
                         <div class="flex justify-between items-center gap-4 text-sm bg-white p-2 rounded mt-2">
                            <div class="flex-1">
                                <span class="text-gray-600">Due on day ${expense.dayOfMonth2}</span>
                            </div>
                            ${paymentStatus2HTML}
                        </div>
                    </li>
                `;
            }).join('');

            return `
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Semi-Monthly Bills</h2>
                    ${semiMonthlyExpenses.length > 0
                        ? `<ul class="space-y-3">${expenseItems}</ul>`
                        : `<p class="text-gray-500">No semi-monthly bills added yet.</p>`
                    }
                </div>
            `;
        }
        
        /**
         * Renders the list of DAILY expenses for the current month.
         * REVISION: Adds Edit and Delete buttons.
         */
        function renderDailyExpenses() {
            const yearMonth = getCurrentYearMonth();
            const dailyExpenses = state.budget.expenses.daily[yearMonth] || [];
            
            const expenseItems = dailyExpenses.map(expense => {
                return `
                    <li class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-3 px-4 rounded-lg bg-gray-50 hover:bg-gray-100">
                        <div class="flex-1 mb-2 sm:mb-0">
                            <span class="font-medium text-gray-800">${expense.name}</span>
                            <span class="block sm:inline sm:ml-2 text-sm text-gray-500">
                                ${expense.category} - ${new Date(expense.date).toLocaleDateString()}
                            </span>
                        </div>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                             <span class="font-semibold text-lg text-gray-800">${formatCurrency(expense.amount)}</span>
                             <button class="btn btn-warning btn-sm edit-expense-btn" 
                                     data-id="${expense.id}" 
                                     data-type="daily" 
                                     data-month="${yearMonth}">
                                 Edit
                             </button>
                             <button class="btn btn-danger btn-sm delete-expense-btn" 
                                     data-id="${expense.id}" 
                                     data-type="daily" 
                                     data-month="${yearMonth}">
                                 Delete
                             </button>
                        </div>
                    </li>
                `;
            }).join('');
            
            return `
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Daily Expenses (${getMonthYearString(state.currentDate)})</h2>
                     ${dailyExpenses.length > 0 
                        ? `<ul class="space-y-2">${expenseItems}</ul>` 
                        : `<p class="text-gray-500">No daily expenses logged for this month.</p>`
                    }
                </div>
            `;
        }
        
        /**
         * Renders the list of UNPLANNED expenses for the current month.
         * REVISION: Adds Edit and Delete buttons.
         */
        function renderUnplannedExpenses() {
            const yearMonth = getCurrentYearMonth();
            const unplannedExpenses = state.budget.expenses.unplanned[yearMonth] || [];
            
            const expenseItems = unplannedExpenses.map(expense => {
                return `
                    <li class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-3 px-4 rounded-lg bg-gray-50 hover:bg-gray-100">
                        <div class="flex-1 mb-2 sm:mb-0">
                            <span class="font-medium text-gray-800">${expense.name}</span>
                            <span class="block sm:inline sm:ml-2 text-sm text-gray-500">
                                ${expense.category} - ${new Date(expense.date).toLocaleDateString()}
                            </span>
                        </div>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                             <span class="font-semibold text-lg text-gray-800">${formatCurrency(expense.amount)}</span>
                             <button class="btn btn-warning btn-sm edit-expense-btn" 
                                     data-id="${expense.id}" 
                                     data-type="unplanned" 
                                     data-month="${yearMonth}">
                                 Edit
                             </button>
                             <button class="btn btn-danger btn-sm delete-expense-btn" 
                                     data-id="${expense.id}" 
                                     data-type="unplanned" 
                                     data-month="${yearMonth}">
                                 Delete
                             </button>
                        </div>
                    </li>
                `;
            }).join('');
            
            return `
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Unplanned Expenses (${getMonthYearString(state.currentDate)})</h2>
                     ${unplannedExpenses.length > 0 
                        ? `<ul class="space-y-2">${expenseItems}</ul>` 
                        : `<p class="text-gray-500">No unplanned expenses logged for this month.</p>`
                    }
                </div>
            `;
        }
        
        /**
         * Renders the Report view.
         */
        function renderReport() {
            const stats = calculateCurrentMonthStats();
            
            const printContent = `
                <div id="report-print-area" class="p-8 bg-white">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Financial Report</h1>
                    <h2 class="text-xl text-gray-600 mb-8">${getMonthYearString(state.currentDate)}</h2>
                    
                    <div class="grid grid-cols-2 gap-6 mb-8">
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-gray-500">Total Income</h3>
                            <p class="text-2xl font-bold text-green-600">${formatCurrency(stats.income)}</p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-gray-500">Total Spent</h3>
                            <p class="text-2xl font-bold text-red-600">${formatCurrency(stats.totalExpenses)}</p>
                        </div>
                         <div class="bg-gray-100 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-gray-500">Remaining Balance</h3>
                            <p class="text-2xl font-bold text-gray-800">${formatCurrency(stats.remainingBalance)}</p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-gray-500">Pending Bills</h3>
                            <p class="text-2xl font-bold text-yellow-600">${formatCurrency(stats.totalPending)}</p>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold mb-4">Expense Breakdown</h3>
                    <ul class="space-y-2">
                        <li>Paid Bills: <span class="font-medium">${formatCurrency(stats.totalPaid)}</span></li>
                        <li>Daily Expenses: <span class="font-medium">${formatCurrency(stats.totalDaily)}</span></li>
                        <li>Unplanned Expenses: <span class="font-medium">${formatCurrency(stats.totalUnplanned)}</span></li>
                    </ul>
                </div>
            `;
            
            return `
                <div class="max-w-7xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">Monthly Report</h1>
                        <button id="print-report-btn" class="btn btn-primary no-print">
                            Print Report
                        </button>
                    </div>
                    
                    <div class="bg-white shadow-lg rounded-xl">
                        ${printContent}
                    </div>
                </div>
            `;
        }
        
        /**
         * Renders the Settings view.
         */
        function renderSettings() {
            return `
                <div class="max-w-xl mx-auto">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Settings</h1>
                    <div class="card">
                        <form id="settings-form" class="space-y-4">
                            <div>
                                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input type="text" id="username" class="form-input" value="${state.settings.username}" required>
                            </div>
                            <div>
                                <label for="currency" class="block text-sm font-medium text-gray-700 mb-1">Currency Code (e.g., USD, PHP)</label>
                                <input type="text" id="currency" class="form-input" value="${state.settings.currency}" required>
                            </div>
                            <button type="submit" class="btn btn-primary py-2.5">Save Settings</button>
                        </form>
                    </div>
                </div>
            `;
        }
        
        
        // --- EVENT HANDLERS ---
        
        /**
         * Adds all global event listeners for the app.
         */
        function addAppEventListeners() {
            // Navigation
            document.querySelectorAll(".nav-link").forEach(link => {
                link.addEventListener("click", (e) => {
                    state.currentView = e.target.dataset.view;
                    renderApp();
                });
            });

            // Dashboard Listeners
            if (state.currentView === 'dashboard') {
                document.getElementById("prev-month-btn")?.addEventListener("click", handlePrevMonth);
                document.getElementById("next-month-btn")?.addEventListener("click", handleNextMonth);
                document.getElementById("edit-income-btn")?.addEventListener("click", () => {
                    document.getElementById("edit-income-form").classList.remove("hidden");
                });
                document.getElementById("cancel-income-btn")?.addEventListener("click", () => {
                     document.getElementById("edit-income-form").classList.add("hidden");
                });
                document.getElementById("save-income-btn")?.addEventListener("click", handleSaveIncome);
            }
            
            // Expenses View Listeners
            if (state.currentView === 'expenses') {
                document.getElementById("expense-type")?.addEventListener("change", handleExpenseTypeChange);
                document.getElementById("add-expense-form")?.addEventListener("submit", handleAddExpense);
                
                // REVISION: Add listeners for new buttons
                document.querySelectorAll(".mark-as-paid-btn").forEach(btn => {
                   btn.addEventListener("click", handleMarkAsPaid);
                });
                document.querySelectorAll(".edit-expense-btn").forEach(btn => {
                   btn.addEventListener("click", showEditExpenseModal);
                });
                document.querySelectorAll(".delete-expense-btn").forEach(btn => {
                   btn.addEventListener("click", showDeleteConfirm);
                });
            }
            
            // Report View Listeners
            if (state.currentView === 'report') {
                document.getElementById("print-report-btn")?.addEventListener("click", () => {
                    window.print();
                });
            }
            
            // Settings View Listeners
            if (state.currentView === 'settings') {
                document.getElementById("settings-form")?.addEventListener("submit", handleSaveSettings);
            }
        }
        
        // --- Modal Event Handlers ---
        
        /**
         * Adds event listeners for the modals (which are always in the DOM).
         */
        function addModalEventListeners() {
            // Edit Expense Modal
            document.getElementById("cancel-edit-btn")?.addEventListener("click", () => {
                editExpenseModal.classList.add("hidden");
            });
            document.getElementById("edit-expense-form")?.addEventListener("submit", handleUpdateExpense);
            
            // Delete Confirm Modal
            document.getElementById("cancel-delete-btn")?.addEventListener("click", () => {
                confirmDeleteModal.classList.add("hidden");
            });
            document.getElementById("confirm-delete-btn")?.addEventListener("click", handleDeleteExpense);
        }
        
        // --- Handler Implementations ---

        function handlePrevMonth() {
            state.currentDate.setMonth(state.currentDate.getMonth() - 1);
            renderApp();
        }
        
        function handleNextMonth() {
            state.currentDate.setMonth(state.currentDate.getMonth() + 1);
            renderApp();
        }
        
        function handleSaveIncome(e) {
            const newIncome = parseFloat(document.getElementById("income-input").value);
            if (!isNaN(newIncome) && newIncome >= 0) {
                const yearMonth = getCurrentYearMonth();
                state.budget.income[yearMonth] = newIncome;
                saveBudget(); // This will trigger a re-render via onSnapshot
                document.getElementById("edit-income-form").classList.add("hidden");
            }
        }

        function handleExpenseTypeChange(e) {
            const type = e.target.value;
            const dayInput = document.getElementById("dayOfMonthInput");
            const semiInput = document.getElementById("semiMonthlyInputs");
            const dateInput = document.getElementById("dateInput");
            
            dayInput.classList.add("hidden");
            semiInput.classList.add("hidden");
            dateInput.classList.add("hidden");
            
            if (type === 'monthly') {
                dayInput.classList.remove("hidden");
            } else if (type === 'semiMonthly') {
                semiInput.classList.remove("hidden");
            } else if (type === 'daily' || type === 'unplanned') {
                dateInput.classList.remove("hidden");
                // Default to today's date
                document.getElementById("expense-date").valueAsDate = new Date();
            }
        }
        
        function handleAddExpense(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.elements['expense-name'].value;
            const amount = parseFloat(form.elements['expense-amount'].value);
            const category = form.elements['expense-category'].value;
            const type = form.elements['expense-type'].value;
            
            const newExpenseBase = {
                id: crypto.randomUUID(),
                name,
                amount,
                category
            };
            
            try {
                if (type === 'monthly') {
                    const dayOfMonth = parseInt(form.elements['expense-day'].value);
                    if (isNaN(dayOfMonth) || dayOfMonth < 1 || dayOfMonth > 31) {
                        throw new Error("Invalid day of month.");
                    }
                    state.budget.expenses.monthly.push({
                        ...newExpenseBase,
                        dayOfMonth,
                        payments: {} // REVISION: Initialize payments map
                    });
                    
                } else if (type === 'semiMonthly') {
                    // REVISION: Handle two due dates
                    const dayOfMonth1 = parseInt(form.elements['expense-day-1'].value);
                    const dayOfMonth2 = parseInt(form.elements['expense-day-2'].value);
                    if (isNaN(dayOfMonth1) || isNaN(dayOfMonth2) || dayOfMonth1 < 1 || dayOfMonth1 > 31 || dayOfMonth2 < 1 || dayOfMonth2 > 31) {
                        throw new Error("Invalid semi-monthly due dates.");
                    }
                    state.budget.expenses.semiMonthly.push({
                        ...newExpenseBase,
                        dayOfMonth1,
                        dayOfMonth2,
                        payments: {} // REVISION: Initialize payments map
                    });
                    
                } else if (type === 'daily' || type === 'unplanned') {
                    const date = form.elements['expense-date'].value;
                    if (!date) {
                         throw new Error("Please select a date.");
                    }
                    const yearMonth = date.slice(0, 7);
                    
                    // Ensure the array for this month exists
                    if (!state.budget.expenses[type][yearMonth]) {
                        state.budget.expenses[type][yearMonth] = [];
                    }
                    
                    state.budget.expenses[type][yearMonth].push({
                        ...newExpenseBase,
                        date: date // Store full date string
                    });
                }
                
                saveBudget(); // Save the updated budget
                form.reset(); // Clear the form
                // Manually trigger the form field visibility logic
                handleExpenseTypeChange({ target: { value: 'daily' } });
                
            } catch (error) {
                console.error("Error adding expense:", error.message);
                // Here you would show an error to the user
                // For now, we'll just log it
            }
        }
        
        function handleSaveSettings(e) {
            e.preventDefault();
            state.settings.username = document.getElementById("username").value;
            state.settings.currency = document.getElementById("currency").value.toUpperCase();
            saveSettings(); // This will save and trigger a re-render
            
            // --- FIX: Replaced alert() with a non-blocking message ---
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.textContent;
            btn.textContent = "Saved!";
            btn.classList.add('bg-green-600', 'text-white');
            btn.classList.remove('bg-blue-600');
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.add('bg-blue-600');
                btn.classList.remove('bg-green-600');
            }, 2000);
            // --- End of Fix ---
        }
        
        /**
         * REVISION: Handles marking a bill as paid.
         */
        function handleMarkAsPaid(e) {
            const { id, type, key, amount } = e.target.dataset;
            
            const expenseList = state.budget.expenses[type];
            const expense = expenseList.find(exp => exp.id === id);
            
            if (expense) {
                if (!expense.payments) {
                    expense.payments = {};
                }
                
                // Add the payment record
                expense.payments[key] = {
                    paidOn: new Date().toISOString(),
                    amount: parseFloat(amount)
                };
                
                saveBudget(); // Save the change
            } else {
                console.error("Could not find expense to mark as paid:", id);
            }
        }
        
        /**
         * REVISION: Shows the modal to edit a daily/unplanned expense.
         */
        function showEditExpenseModal(e) {
            const { id, type, month } = e.target.dataset;
            
            const expense = state.budget.expenses[type][month]?.find(exp => exp.id === id);
            
            if (expense) {
                // Populate the modal form
                document.getElementById("edit-expense-id").value = id;
                document.getElementById("edit-expense-type").value = type;
                document.getElementById("edit-expense-month").value = month;
                document.getElementById("edit-expense-name").value = expense.name;
                document.getElementById("edit-expense-amount").value = expense.amount;
                document.getElementById("edit-expense-date").value = expense.date;
                
                // Show the modal
                editExpenseModal.classList.remove("hidden");
            } else {
                console.error("Could not find expense to edit:", id);
            }
        }
        
        /**
         * REVISION: Saves the changes from the edit modal.
         */
        function handleUpdateExpense(e) {
            e.preventDefault();
            
            // Get data from the hidden fields
            const id = document.getElementById("edit-expense-id").value;
            const type = document.getElementById("edit-expense-type").value;
            const month = document.getElementById("edit-expense-month").value;
            
            // Get new values
            const name = document.getElementById("edit-expense-name").value;
            const amount = parseFloat(document.getElementById("edit-expense-amount").value);
            const date = document.getElementById("edit-expense-date").value;
            
            const expenseList = state.budget.expenses[type][month];
            const expenseIndex = expenseList?.findIndex(exp => exp.id === id);
            
            if (expenseIndex !== -1 && expenseList) {
                // Update the expense in the state
                expenseList[expenseIndex] = {
                    ...expenseList[expenseIndex],
                    name,
                    amount,
                    date
                };
                
                // Check if the month changed
                const newMonth = date.slice(0, 7);
                if (newMonth !== month) {
                    // Remove from old month
                    const [movedExpense] = expenseList.splice(expenseIndex, 1);
                    // Add to new month
                    if (!state.budget.expenses[type][newMonth]) {
                         state.budget.expenses[type][newMonth] = [];
                    }
                    state.budget.expenses[type][newMonth].push(movedExpense);
                }
                
                saveBudget();
                editExpenseModal.classList.add("hidden");
            } else {
                console.error("Error updating expense:", id);
            }
        }
        
        /**
         * REVISION: Shows the confirm deletion modal.
         */
        function showDeleteConfirm(e) {
            const { id, type, month } = e.target.dataset;
            
            // Store data on the confirm button
            const confirmBtn = document.getElementById("confirm-delete-btn");
            confirmBtn.dataset.id = id;
            confirmBtn.dataset.type = type;
            confirmBtn.dataset.month = month;
            
            // Show the modal
            confirmDeleteModal.classList.remove("hidden");
        }
        
        /**
         * REVISION: Handles the actual deletion after confirmation.
         */
        function handleDeleteExpense(e) {
            const { id, type, month } = e.target.dataset;
            
            const expenseList = state.budget.expenses[type][month];
            const expenseIndex = expenseList?.findIndex(exp => exp.id === id);

            if (expenseIndex !== -1 && expenseList) {
                // Remove the expense from the array
                expenseList.splice(expenseIndex, 1);
                
                saveBudget();
                confirmDeleteModal.classList.add("hidden");
            } else {
                console.error("Error deleting expense:", id);
            }
        }


        // --- APPLICATION INITIALIZATION ---

        /**
         * Main function to start the app.
         */
        async function main() {
            // Check for Firebase config
            if (typeof __firebase_config === 'undefined' || !__firebase_config) {
                console.error("Firebase config is missing.");
                appRoot.innerHTML = `<div class="p-8 text-center text-red-600">
                    <h2 class="text-2xl font-bold">Firebase Config Missing</h2>
                    <p class=mt-2>The application cannot start.</p>
                </div>`;
                return;
            }
            
            // Show loading screen
            renderApp();

            try {
                // Parse config
                const firebaseConfig = JSON.parse(__firebase_config);
                
                // Initialize Firebase
                state.app = initializeApp(firebaseConfig);
                state.db = getFirestore(state.app);
                state.auth = getAuth(state.app);
                
                // Enable debug logging for Firestore
                setLogLevel('Debug');
                
                // Add modal listeners once
                addModalEventListeners();
                
                // --- REVISED: Listen for Google login button ---
                appRoot.addEventListener("click", async (e) => {
                    // Find the button if clicked inside the SVG
                    const googleBtn = e.target.closest('#google-login-btn');
                    if (googleBtn) {
                        try {
                            state.loading = true;
                            renderApp();
                            
                            // Check for platform token first (if it exists)
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(state.auth, __initial_auth_token);
                            } else {
                                // Fallback: Use Google Sign-in Popup
                                const provider = new GoogleAuthProvider();
                                await signInWithPopup(state.auth, provider);
                            }
                        } catch (error) {
                            console.error("Sign-in failed:", error);
                            state.loading = false;
                            renderApp();
                        }
                    }
                });

                // --- Auth State ---
                // This is the main entry point for the app logic
                onAuthStateChanged(state.auth, (user) => {
                    if (user) {
                        // User is signed in!
                        state.userId = user.uid;
                        state.isAuthReady = true;
                        state.loading = true; // Set to loading while we fetch data
                        
                        // Detach any old listeners before attaching new ones
                        state.unsubSettings();
                        state.unsubBudget();
                        
                        attachDataListeners(); // This will fetch data and render the app
                        
                    } else {
                        // User is signed out!
                        state.userId = null;
                        state.isAuthReady = false;
                        state.loading = false;
                        
                        // Detach listeners
                        state.unsubSettings();
                        state.unsubBudget();

                        renderApp(); // This will call renderLoginScreen()
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                appRoot.innerHTML = `<div class="p-8 text-center text-red-600 no-print">
                    <h2 class="text-2xl font-bold">Error connecting to database</h2>
                    <p class=mt-2>Could not initialize Firebase. Please check your console and Firebase configuration.</p>
                </div>`;
            }
        }
        
        // Start the application
        main();

    </script>
</body>
</html>
