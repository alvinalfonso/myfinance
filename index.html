<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Financial Tracker</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 2. Set default font to match the app */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for animations or specific elements */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        /* Style for a simple modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        /* Print styles for the report */
        @media print {
            body * {
                visibility: hidden;
            }
            #report-print-area, #report-print-area * {
                visibility: visible;
            }
            #report-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- 3. Root container where the app will be rendered -->
    <div id="app-root"></div>

    <!-- 4. Modal container, hidden by default -->
    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden no-print">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <!-- Modal content will be injected here by JavaScript -->
        </div>
    </div>

    <!-- 5. Firebase and App Logic -->
    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut,
            GoogleAuthProvider,
            signInWithPopup // Using Popup as requested
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            onSnapshot,
            updateDoc,
            arrayUnion,
            arrayRemove,
            collection, // Needed for reports
            query, // Needed for reports
            where, // Needed for reports
            getDocs // Needed for reports
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        
        // --- Lucide Icons (as functions) ---
        const icons = {
            home: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`,
            trendingUp: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>`,
            settings: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73v.18a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>`,
            clipboard: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path></svg>`, // New icon for Reports
            logOut: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>`,
            dollarSign: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>`,
            creditCard: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1"><rect width="20" height="14" x="2" y="5" rx="2"></rect><line x1="2" y1="10" x2="22" y2="10"></line></svg>`,
            plus: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            trash2: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`,
            calendarDays: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-3 h-3 mr-1"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line><path d="M8 14h.01"></path><path d="M12 14h.01"></path><path d="M16 14h.01"></path><path d="M8 18h.01"></path><path d="M12 18h.01"></path><path d="M16 18h.01"></path></svg>`,
            clipboardEdit: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><path d="M14.39 16.61.7 10.93a1 1 0 0 1 0-1.42l.7-.7a1 1 0 0 1 1.42 0l5.66 5.66"></path><path d="m14 17 5.66-5.66a1 1 0 0 1 1.42 0l.7.7a1 1 0 0 1 0 1.42L15.42 19.5a1 1 0 0 1-1.42 0"></path></svg>`,
            x: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
            google: `<svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2"><title>Google</title><path d="M12.48 10.92v3.28h7.84c-.24 1.54-.88 2.76-1.9 3.55l2.6 2.04c2-1.84 3.22-4.48 3.22-7.58 0-5.74-4.42-10.4-10-10-5.52 0-10 4.48-10 10s4.48 10 10 10c2.18 0 4.16-.76 5.74-2.04l-2.6-2.04c-.6.44-1.48.76-2.6.76-3.3 0-6-2.68-6-6s2.7-6 6-6c1.66 0 3.14.68 4.2 1.72l2.54-2.54C16.6 2.76 14.58 2 12.48 2z" fill="#4285F4"></path></svg>`,
            printer: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect width="12" height="8" x="6" y="14"></rect></svg>` // New icon for Print
        };

        // --- Firebase Config & App State ---
        
        // This is YOUR personal config that you provided
        const firebaseConfig = {
            apiKey: "AIzaSyDllC4nXTDgtMMfw6CO0t92j820SOY7MPQ",
            authDomain: "my-budget-tracker-23b15.firebaseapp.com",
            projectId: "my-budget-tracker-23b15",
            storageBucket: "my-budget-tracker-23b15.firebasestorage.app",
            messagingSenderId: "341614311933",
            appId: "1:341614311933:web:32b48db5576be8d7fb0194",
            measurementId: "G-44L5LDN7MW"
        };
        
        // This 'appId' is for the database path, not Firebase config.
        const appId = 'default-app-id'; // Use a stable ID for your GitHub Pages app

        let auth, db, app, analytics, googleProvider;
        
        // Global state object
        const state = {
            view: 'tracker', // tracker, settings, forecast, reports
            currentMonthId: getMonthId(),
            settings: null,
            currentBudget: null,
            userId: null,
            isAuthReady: false, // This now means "is user logged in?"
            loading: true,
            unsubSettings: () => {},
            unsubBudget: () => {},
        };

        // --- DOM Elements ---
        const appRoot = document.getElementById('app-root');
        const modalContainer = document.getElementById('modal-container');
        const modalContent = document.getElementById('modal-content');

        // --- Helper Functions ---
        function getMonthId(date = new Date()) {
            return date.toISOString().slice(0, 7); // "YYYY-MM"
        }

        function getNextMonthId(monthId, increment = 1) {
            const [year, month] = monthId.split('-').map(Number);
            const date = new Date(year, month - 1, 1);
            date.setMonth(date.getMonth() + increment);
            return getMonthId(date);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-PH', {
                style: 'currency',
                currency: 'PHP',
            }).format(amount);
        }

        // --- Render Functions ---

        /** Renders the new Login Screen */
        function renderLoginScreen() {
             appRoot.innerHTML = `
                <div class="flex items-center justify-center min-h-screen bg-gray-100">
                    <div class="bg-white shadow-xl rounded-lg p-8 w-full max-w-md mx-4 text-center">
                        <h2 class="text-2xl font-bold text-blue-700 mb-4">Welcome to Your Budget Tracker</h2>
                        <p class="text-sm text-gray-600 mb-8">
                            Sign in with your Google account to securely access and sync your budget.
                        </p>
                        <button id="google-signin-button" class="w-full font-medium rounded-lg transition-colors bg-white text-gray-700 hover:bg-gray-50 border border-gray-300 shadow-sm px-4 py-3 text-base flex items-center justify-center">
                            ${icons.google}
                            Sign in with Google
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('google-signin-button').onclick = handleGoogleSignIn;
        }
        
        /** Renders the entire application based on the current state */
        function renderApp() {
            // If user is not logged in, show the login screen.
            if (!state.isAuthReady) {
                renderLoginScreen();
                return;
            }
            
            // If user is logged in, but data is loading, show loading screen.
            if (state.loading) {
                appRoot.innerHTML = renderLoadingScreen();
                return;
            }

            const nav = renderNavigation();
            let mainContent = '';

            if (state.view === 'tracker' && state.currentBudget) {
                mainContent = renderMonthlyTracker();
            } else if (state.view === 'settings' && state.settings) {
                mainContent = renderSettingsView();
            } else if (state.view === 'forecast' && state.currentBudget && state.settings) {
                mainContent = renderForecastView();
            } else if (state.view === 'reports') {
                mainContent = renderReportsView(); // New View
            } else if (!state.currentBudget && state.view === 'tracker') {
                // Handle case where budget is still loading or being created
                mainContent = renderLoadingScreen();
            }

            appRoot.innerHTML = `
                <div class="no-print">
                    ${nav}
                </div>
                <main class="p-4 md:p-8">
                    ${mainContent}
                </main>
            `;
            
            // Re-attach event listeners
            attachNavListeners();
            attachMainListeners();
        }

        /** Renders the top navigation bar */
        function renderNavigation() {
            return `
                <header class="bg-white shadow-md p-4 flex justify-between items-center no-print">
                    <h1 class="text-2xl font-bold text-blue-700">Personal Financial Tracker</h1>
                    <nav class="flex items-center space-x-2">
                        <button data-view="tracker" class="nav-button p-2 rounded-lg ${state.view === 'tracker' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}">${icons.home}</button>
                        <button data-view="forecast" class="nav-button p-2 rounded-lg ${state.view === 'forecast' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}">${icons.trendingUp}</button>
                        <button data-view="reports" class="nav-button p-2 rounded-lg ${state.view === 'reports' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}">${icons.clipboard}</button>
                        <button data-view="settings" class="nav-button p-2 rounded-lg ${state.view === 'settings' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}">${icons.settings}</button>
                        <button id="sign-out-button" title="Sign Out" class="p-2 rounded-lg text-red-600 hover:bg-red-100">
                            ${icons.logOut}
                        </button>
                    </nav>
                </header>
            `;
        }
        
        /** Renders the loading screen */
        function renderLoadingScreen() {
            return `
                <div class="flex items-center justify-center min-h-screen bg-gray-100 no-print">
                    <div class="flex flex-col items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="mt-2 text-lg text-gray-700">Loading Your Financials...</span>
                    </div>
                </div>
            `;
        }

        /** Renders the main tracker view */
        function renderMonthlyTracker() {
            const getMonthOptions = () => {
                let options = '';
                const today = new Date();
                for (let i = -6; i <= 6; i++) {
                    const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
                    const monthId = getMonthId(date);
                    const selected = monthId === state.currentMonthId ? 'selected' : '';
                    const label = new Date(monthId + '-02').toLocaleString('default', { month: 'long', year: 'numeric' });
                    options += `<option value="${monthId}" ${selected}>${label}</option>`;
                }
                return options;
            };

            return `
                <div class="space-y-6 no-print">
                    <div class="flex justify-between items-center">
                        <h2 class="text-3xl font-bold">Monthly Tracker</h2>
                        <select id="month-select" class="p-2 border rounded-lg shadow-sm">
                            ${getMonthOptions()}
                        </select>
                    </div>
                    
                    ${renderSummaryView(state.currentBudget)}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${renderIncomeTracker(state.currentBudget, state.settings)}
                        ${renderOtherExpensesTracker(state.currentBudget)}
                        ${renderRecurringExpensesTracker(state.currentBudget, 'recurringExpenses', 'Fixed Monthly Expenses (Bills, Loans, etc.)')}
                        ${renderRecurringExpensesTracker(state.currentBudget, 'semiMonthlyExpenses', 'Semi-Monthly Expenses')}
                    </div>
                </div>
            `;
        }

        /** Renders the summary card */
        function renderSummaryView(budget) {
            const { income, recurringExpenses, semiMonthlyExpenses, variableExpenses } = budget;

            const totalExpectedIncome = income.payout1.expected + income.payout2.expected;
            const totalActualIncome = (income.payout1.isPaid ? income.payout1.actual : 0) + (income.payout2.isPaid ? income.payout2.actual : 0);

            const totalExpectedExpenses = [...recurringExpenses, ...semiMonthlyExpenses].reduce((sum, item) => sum + item.expected, 0);
            const totalActualExpenses = 
                [...recurringExpenses, ...semiMonthlyExpenses].reduce((sum, item) => sum + (item.isPaid ? item.actual : 0), 0) +
                variableExpenses.reduce((sum, item) => sum + item.amount, 0);
                
            const actualNet = totalActualIncome - totalActualExpenses;
            const expectedNet = totalExpectedIncome - totalExpectedExpenses;

            const remainingToPay = [...recurringExpenses, ...semiMonthlyExpenses]
                .filter(item => !item.isPaid)
                .reduce((sum, item) => sum + item.expected, 0);
                
            const cashOnHand = totalActualIncome - totalActualExpenses;

            const statBox = (title, value, color) => `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="text-sm font-medium text-gray-500">${title}</h4>
                    <p class="text-2xl font-bold ${color}">${value}</p>
                </div>`;

            return `
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <div class="p-4 md:p-6 border-b">
                        <h3 class="text-xl font-semibold">Month Summary: ${new Date(budget.month + '-02').toLocaleString('default', { month: 'long', year: 'numeric' })}</h3>
                    </div>
                    <div class="p-4 md:p-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                        ${statBox('Cash on Hand', formatCurrency(cashOnHand), cashOnHand >= 0 ? 'text-green-600' : 'text-red-600')}
                        ${statBox('Actual Net', formatCurrency(actualNet), actualNet >= 0 ? 'text-green-600' : 'text-red-600')}
                        ${statBox('Remaining Bills', formatCurrency(remainingToPay), 'text-yellow-600')}
                        ${statBox('Budgeted Net', formatCurrency(expectedNet), 'text-gray-600')}
                    </div>
                </div>
            `;
        }

        /** Renders the income tracker card */
        function renderIncomeTracker(budget, settings) {
            const payoutItem = (payout, payoutKey, title) => {
                if (payout.isPaid) {
                    return `
                        <div class="text-right">
                            <span class="text-green-600 font-bold text-lg">${formatCurrency(payout.actual)}</span>
                            <div class="flex items-center justify-end space-x-2">
                                <button data-payout-key="${payoutKey}" class="payout-unpay text-xs text-yellow-600 hover:underline">Mark as Unpaid</button>
                                <button data-payout-key="${payoutKey}" class="payout-edit text-xs text-blue-600 hover:underline">Edit</button>
                            </div>
                        </div>`;
                } else {
                    return `<button data-payout-key="${payoutKey}" class="payout-edit font-medium rounded-lg transition-colors bg-blue-600 text-white hover:bg-blue-700 px-2 py-1 text-xs flex items-center">${icons.dollarSign} Mark as Paid</button>`;
                }
            };

            return `
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <div class="p-4 md:p-6 border-b"><h3 class="text-xl font-semibold">Income</h3></div>
                    <div class="p-4 md:p-6 space-y-4">
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div>
                                <h4 class="font-medium">${settings.payout1Label}</h4>
                                <span class="text-sm text-gray-500">Expected: ${formatCurrency(budget.income.payout1.expected)}</span>
                            </div>
                            ${payoutItem(budget.income.payout1, 'payout1', settings.payout1Label)}
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div>
                                <h4 class="font-medium">${settings.payout2Label}</h4>
                                <span class="text-sm text-gray-500">Expected: ${formatCurrency(budget.income.payout2.expected)}</span>
                            </div>
                            ${payoutItem(budget.income.payout2, 'payout2', settings.payout2Label)}
                        </div>
                    </div>
                </div>
            `;
        }

        /** Renders the recurring expenses card */
        function renderRecurringExpensesTracker(budget, expenseKey, title) {
            const expenses = budget[expenseKey] || [];
            
            const expenseItems = expenses.map((item, index) => {
                let paidStatus = '';
                if (item.isPaid) {
                    paidStatus = `
                        <div class="text-right">
                            <span class="text-red-600 font-bold text-lg">${formatCurrency(item.actual)}</span>
                            <div class="flex items-center justify-end space-x-2">
                                <button data-key="${expenseKey}" data-index="${index}" class="expense-unpay text-xs text-yellow-600 hover:underline">Mark as Unpaid</button>
                                <button data-key="${expenseKey}" data-index="${index}" class="expense-edit text-xs text-blue-600 hover:underline">Edit</button>
                            </div>
                        </div>`;
                } else {
                    paidStatus = `<button data-key="${expenseKey}" data-index="${index}" class="expense-edit font-medium rounded-lg transition-colors bg-white text-blue-700 border border-blue-600 hover:bg-blue-50 px-2 py-1 text-xs flex items-center">${icons.creditCard} Pay</button>`;
                }

                // --- NEW UI LOGIC for payment types ---
                let paymentTypeInfo = '';
                if (item.paymentType === 'oneTime') {
                    paymentTypeInfo = `<span class="ml-2 text-xs text-indigo-600">(One-Time, Due: ${item.dueMonth})</span>`;
                } else {
                    // Default to "Monthly"
                    paymentTypeInfo = `<span class="ml-2 text-xs text-green-600">(Monthly)</span>`;
                }

                return `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div>
                            <h4 class="font-medium">${item.name} ${paymentTypeInfo}</h4>
                            <span class="text-sm text-gray-500">Expected: ${formatCurrency(item.expected)}</span>
                            ${item.paymentType === 'monthly' && item.monthlyDueDate ? `
                                <div class="flex items-center text-xs text-blue-600 mt-1">
                                    ${icons.calendarDays}
                                    Due: ${item.monthlyDueDate}
                                    ${item.endTerm ? `<span class="ml-2">| Ends: ${item.endTerm}</span>` : ''}
                                </div>` : ''
                            }
                        </div>
                        ${paidStatus}
                    </div>
                `;
            }).join('');

            return `
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <div class="p-4 md:p-6 border-b"><h3 class="text-xl font-semibold">${title}</h3></div>
                    <div class="p-4 md:p-6 space-y-2">
                        ${expenses.length === 0 ? `<p class="text-gray-500 text-sm">No ${title.toLowerCase()} configured. Go to Settings to add some.</p>` : expenseItems}
                    </div>
                </div>
            `;
        }

        /** Renders the "Daily & Unplanned Expenses" card */
        function renderOtherExpensesTracker(budget) {
            const expenseItems = budget.variableExpenses.map(item => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                        <h4 class="font-medium">${item.name}</h4>
                        <span class="text-sm text-gray-500">${new Date(item.date).toLocaleDateString()}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="font-medium text-red-600">${formatCurrency(item.amount)}</span>
                        <button data-id="${item.id}" class="variable-delete font-medium rounded-lg transition-colors bg-transparent text-gray-700 hover:bg-gray-100 p-2">
                            ${icons.trash2}
                        </button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <div class="p-4 md:p-6 border-b"><h3 class="text-xl font-semibold">Daily & Unplanned Expenses</h3></div>
                    <div class="p-4 md:p-6">
                        <form id="variable-expense-form" class="flex space-x-2 mb-4">
                            <input type="text" id="variable-name" placeholder="Expense Name" class="border border-gray-300 rounded-lg p-2 text-sm w-full focus:ring-2 focus:ring-blue-500 focus:outline-none flex-1" required />
                            <input type="number" id="variable-amount" placeholder="Amount" class="border border-gray-300 rounded-lg p-2 text-sm w-full focus:ring-2 focus:ring-blue-500 focus:outline-none w-28" required />
                            <button type="submit" class="font-medium rounded-lg transition-colors bg-blue-600 text-white hover:bg-blue-700 p-2">
                                ${icons.plus}
                            </button>
                        </form>
                        <div class="space-y-2 max-h-60 overflow-y-auto pr-2">
                            ${budget.variableExpenses.length === 0 ? '<p class="text-gray-500 text-sm">No other expenses logged for this month.</p>' : expenseItems}
                        </div>
                    </div>
                </div>
            `;
        }

        /** Renders the settings view */
        function renderSettingsView() {
            return `
                <div class="space-y-6 max-w-4xl mx-auto no-print">
                    <h2 class="text-3xl font-bold">Settings</h2>
                    
                    <div class="bg-white shadow-md rounded-lg overflow-hidden">
                        <div class="p-4 md:p-6 border-b"><h3 class="text-xl font-semibold">Income</h3></div>
                        <div class="p-4 md:p-6 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Payout 1 Label</label>
                                    <input type="text" id="setting-payout1-label" value="${state.settings.payout1Label}" class="border border-gray-300 rounded-lg p-2 text-sm w-full focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Average Payout 1 Amount</label>
                                    <input type="number" id="setting-payout1" value="${state.settings.avgPayout1}" class="border border-gray-300 rounded-lg p-2 text-sm w-full focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Payout 2 Label</label>
                                    <input type="text" id="setting-payout2-label" value="${state.settings.payout2Label}" class="border border-gray-300 rounded-lg p-2 text-sm w-full focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Average Payout 2 Amount</label>
                                    <input type="number" id="setting-payout2" value="${state.settings.avgPayout2}" class="border border-gray-300 rounded-lg p-2 text-sm w-full focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                                </div>
                            </div>
                            <button id="save-income-settings" class="font-medium rounded-lg transition-colors bg-blue-600 text-white hover:bg-blue-700 px-4 py-2 text-sm">Save Income Settings</button>
                        </div>
                    </div>

                    ${renderTemplateEditor('Fixed Monthly Expenses (Bills, Loans, etc.)', 'recurringTemplate', state.settings.recurringTemplate, true)}
                    ${renderTemplateEditor('Semi-Monthly Expenses', 'semiMonthlyExpensesTemplate', state.settings.semiMonthlyExpensesTemplate, false)}
                </div>
            `;
        }

        /** Renders a template editor card for the settings page */
        function renderTemplateEditor(title, key, items, isFixedExpense) {
            const itemsHtml = items.map(item => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                        <h4 class="font-medium">${item.name}</h4>
                        <span class="text-sm text-gray-500">Expected: ${formatCurrency(item.expected)}</span>
                        
                        <!-- NEW: Show payment type info -->
                        ${item.paymentType === 'oneTime' ? `
                            <div class="flex items-center text-xs text-indigo-600 mt-1">
                                ${icons.calendarDays}
                                One-Time, Due: ${item.dueMonth || 'N/A'}
                            </div>
                        ` : `
                            ${isFixedExpense && item.monthlyDueDate ? `
                                <div class="flex items-center text-xs text-blue-600 mt-1">
                                    ${icons.calendarDays}
                                    Monthly, Due: ${item.monthlyDueDate}
                                    ${item.endTerm ? `<span class="ml-2">| Ends: ${item.endTerm}</span>` : ''}
                                </div>` 
                            : `<div class="flex items-center text-xs text-green-600 mt-1">Monthly</div>`
                            }
                        `}
                    </div>
                    <div class="flex space-x-1">
                        <button data-key="${key}" data-id="${item.id}" data-is-fixed="${isFixedExpense}" class="template-edit font-medium rounded-lg transition-colors bg-transparent text-gray-700 hover:bg-gray-100 p-2">
                            ${icons.clipboardEdit}
                        </button>
                        <button data-key="${key}" data-id="${item.id}" class="template-delete font-medium rounded-lg transition-colors bg-transparent text-gray-700 hover:bg-gray-100 p-2">
                            ${icons.trash2}
                        </button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <div class="p-4 md:p-6 border-b flex flex-row justify-between items-center">
                        <h3 class="text-xl font-semibold">${title}</h3>
                        <button data-key="${key}" data-is-fixed="${isFixedExpense}" class="template-add font-medium rounded-lg transition-colors bg-blue-600 text-white hover:bg-blue-700 px-2 py-1 text-xs flex items-center">
                            ${icons.plus} Add New
                        </button>
                    </div>
                    <div class="p-4 md:p-6">
                        <p class="text-sm text-gray-600 mb-4">These items will be automatically added to your budget each new month.</p>
                        <div class="space-y-2">
                            ${items.length === 0 ? '<p class="text-gray-500">No items in this template.</p>' : itemsHtml}
                        </div>
                    </div>
                </div>
            `;
        }
        
        /** Renders the 3-month forecast view */
        function renderForecastView() {
            const forecastMonths = [];
            let startingBalance = 0;

            // 1. Calculate Current Month's Outcome
            const { income, recurringExpenses, semiMonthlyExpenses, variableExpenses } = state.currentBudget;
            
            const actualIncome = (income.payout1.isPaid ? income.payout1.actual : 0) + (income.payout2.isPaid ? income.payout2.actual : 0);
            const actualExpenses = 
                [...recurringExpenses, ...semiMonthlyExpenses].reduce((sum, item) => sum + (item.isPaid ? item.actual : 0), 0) +
                variableExpenses.reduce((sum, item) => sum + item.amount, 0);
            startingBalance = actualIncome - actualExpenses; // This is the cash on hand

            const remainingIncome = 
                (income.payout1.isPaid ? 0 : income.payout1.expected) +
                (income.payout2.isPaid ? 0 : income.payout2.expected);
                
            const remainingExpenses = 
                [...recurringExpenses, ...semiMonthlyExpenses].filter(item => !item.isPaid)
                .reduce((sum, item) => sum + item.expected, 0);

            const thisMonthEndBalance = startingBalance + remainingIncome - remainingExpenses;
            
            forecastMonths.push({
                month: state.currentMonthId, // --- FIX: Use state.currentMonthId ---
                start: 0, 
                income: actualIncome + remainingIncome,
                expenses: actualExpenses + remainingExpenses,
                end: thisMonthEndBalance,
                isCurrent: true
            });
            
            startingBalance = thisMonthEndBalance; // Set for next month's calculation

            // 2. Calculate Next 3 Months
            const expectedMonthlyIncome = state.settings.avgPayout1 + state.settings.avgPayout2;
            
            // --- FIX: Smarter expense calculation ---
            const allTemplateExpenses = [
                ...state.settings.recurringTemplate, 
                ...state.settings.semiMonthlyExpensesTemplate
            ];

            let currentMonthId = state.currentMonthId; // --- FIX: Use state.currentMonthId ---
            for (let i = 0; i < 3; i++) {
                currentMonthId = getNextMonthId(currentMonthId); // Get NEXT month
                
                // Calculate expenses specifically for *this* future month
                const expectedMonthlyExpenses = allTemplateExpenses.reduce((sum, item) => {
                    if (item.paymentType === 'monthly') {
                        return sum + item.expected; // Add all monthly items
                    }
                    if (item.paymentType === 'oneTime' && item.dueMonth === currentMonthId) {
                        return sum + item.expected; // Add one-time items *only* if they are due this month
                    }
                    return sum; // Otherwise, add nothing
                }, 0);

                const endBalance = startingBalance + expectedMonthlyIncome - expectedMonthlyExpenses;
                forecastMonths.push({
                    month: currentMonthId,
                    start: startingBalance,
                    income: expectedMonthlyIncome,
                    expenses: expectedMonthlyExpenses,
                    end: endBalance,
                    isCurrent: false
                });
                startingBalance = endBalance;
            }

            const statBox = (title, value, color) => `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="text-sm font-medium text-gray-500">${title}</h4>
                    <p class="text-2xl font-bold ${color}">${value}</p>
                </div>`;
            
            const monthCards = forecastMonths.map(month => `
                <div class="bg-white shadow-md rounded-lg overflow-hidden ${month.isCurrent ? 'border-blue-500 border-2' : ''}">
                    <div class="p-4 md:p-6 border-b">
                        <h3 class="text-xl font-semibold">${new Date(month.month + '-02').toLocaleString('default', { month: 'long', year: 'numeric' })}</h3>
                        ${month.isCurrent ? `<span class="text-xs font-medium text-blue-600">CURRENT MONTH (Projected)</span>` : ''}
                    </div>
                    <div class="p-4 md:p-6 space-y-2">
                        ${!month.isCurrent ? statBox('Starting Balance', formatCurrency(month.start), 'text-gray-700') : ''}
                        ${statBox('Projected Income', formatCurrency(month.income), 'text-green-600')}
                        ${statBox('Projected Expenses', formatCurrency(month.expenses), 'text-red-600')}
                        ${statBox('Projected End Balance', formatCurrency(month.end), month.end >= 0 ? 'text-blue-700' : 'text-red-700')}
                    </div>
                </div>
            `).join('');

            return `
                <div class="space-y-6 no-print">
                    <h2 class="text-3xl font-bold">3-Month Forecast</h2>
                    <p class="text-gray-600">This forecast uses your average income and recurring expenses from your settings. It does not include 'Daily & Unplanned Expenses'.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        ${monthCards}
                    </div>
                </div>
            `;
        }
        
        /** NEW: Renders the reports view */
        function renderReportsView() {
            const getMonthOptions = () => {
                let options = '';
                const today = new Date();
                for (let i = 0; i > -12; i--) { // Go back 12 months
                    const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
                    const monthId = getMonthId(date);
                    const selected = monthId === state.currentMonthId ? 'selected' : '';
                    const label = new Date(monthId + '-02').toLocaleString('default', { month: 'long', year: 'numeric' });
                    options += `<option value="${monthId}" ${selected}>${label}</option>`;
                }
                return options;
            };

            return `
                <div class="space-y-6 max-w-4xl mx-auto">
                    <div class="flex justify-between items-center no-print">
                        <h2 class="text-3xl font-bold">Reports</h2>
                        <div class="flex space-x-2">
                             <select id="report-month-select" class="p-2 border rounded-lg shadow-sm">
                                ${getMonthOptions()}
                            </select>
                            <button id="print-report-button" class="font-medium rounded-lg transition-colors bg-blue-600 text-white hover:bg-blue-700 px-4 py-2 text-sm flex items-center">
                                ${icons.printer} Print / Download
                            </button>
                        </div>
                    </div>
                    
                    <div id="report-content" class="bg-white shadow-md rounded-lg p-8">
                        <!-- Report content will be loaded here -->
                        <p class="text-gray-500">Select a month to generate a report.</p>
                    </div>
                </div>
            `;
        }
        
        /** NEW: Generates and renders the content for a report */
        async function generateReport(monthId) {
            const reportContentEl = document.getElementById('report-content');
            reportContentEl.innerHTML = `<div class="text-center"><p>Loading report for ${monthId}...</p></div>`;

            // Get the budget data for the selected month
            const budgetRef = doc(db, 'artifacts', appId, 'users', state.userId, 'budgets', monthId);
            const docSnap = await getDoc(budgetRef);

            if (!docSnap.exists()) {
                reportContentEl.innerHTML = `<div class="text-center text-red-500"><p>No data found for ${monthId}.</p></div>`;
                return;
            }

            const budget = docSnap.data();
            const { income, recurringExpenses, semiMonthlyExpenses, variableExpenses } = budget;

            // --- Calculations ---
            const totalIncome = (income.payout1.isPaid ? income.payout1.actual : 0) + (income.payout2.isPaid ? income.payout2.actual : 0);
            
            const totalRecurring = recurringExpenses
                .filter(item => item.isPaid)
                .reduce((sum, item) => sum + item.actual, 0);
                
            const totalSemiMonthly = semiMonthlyExpenses // Renamed
                .filter(item => item.isPaid)
                .reduce((sum, item) => sum + item.actual, 0);
                
            const totalVariable = variableExpenses.reduce((sum, item) => sum + item.amount, 0);
            
            const totalExpenses = totalRecurring + totalSemiMonthly + totalVariable; // Updated
            const netIncome = totalIncome - totalExpenses;

            // --- Table Builders ---
            const renderRow = (label, value) => `
                <tr class="border-b">
                    <td class="py-2 pr-4 text-gray-600">${label}</td>
                    <td class="py-2 text-right font-medium">${formatCurrency(value)}</td>
                </tr>`;
            
            const renderHeaderRow = (label, value) => `
                <tr class="border-t-2 border-b">
                    <td class="py-2 pr-4 font-bold">${label}</td>
                    <td class="py-2 text-right font-bold">${formatCurrency(value)}</td>
                </tr>`;
            
            const renderFinalRow = (label, value) => `
                <tr class="border-t-2 border-b-2 border-gray-800 bg-gray-100">
                    <td class="py-2 pr-4 font-bold text-lg">${label}</td>
                    <td class="py-2 text-right font-bold text-lg ${value >= 0 ? 'text-green-700' : 'text-red-700'}">${formatCurrency(value)}</td>
                </tr>`;

            // --- HTML Structure ---
            reportContentEl.innerHTML = `
                <div id="report-print-area">
                    <h3 class="text-2xl font-bold text-center">Statement of Income & Expenses</h3>
                    <p class="text-center text-gray-500 mb-6">${new Date(monthId + '-02').toLocaleString('default', { month: 'long', year: 'numeric' })}</p>
                    
                    <table class="w-full text-sm">
                        <thead>
                            <tr>
                                <th class="text-left text-lg font-semibold text-gray-800 pb-2" colspan="2">Income</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(income.payout1.isPaid ? renderRow(state.settings.payout1Label, income.payout1.actual) : '')}
                            ${(income.payout2.isPaid ? renderRow(state.settings.payout2Label, income.payout2.actual) : '')}
                            ${renderHeaderRow('Total Income', totalIncome)}
                        </tbody>
                    </table>
                    
                    <table class="w-full text-sm mt-6">
                        <thead>
                            <tr>
                                <th class="text-left text-lg font-semibold text-gray-800 pb-2" colspan="2">Expenses</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="font-medium bg-gray-50"><td class="py-1 px-2" colspan="2">Fixed Monthly Expenses</td></tr>
                            ${recurringExpenses.filter(i => i.isPaid).map(item => renderRow(item.name, item.actual)).join('')}
                            <tr class="border-t"><td class="py-1 pr-4 text-gray-600 font-semibold text-right">Subtotal</td><td class="py-1 text-right font-semibold">${formatCurrency(totalRecurring)}</td></tr>
                            
                            <tr class="font-medium bg-gray-50"><td class="py-1 px-2 mt-2" colspan="2">Semi-Monthly Expenses</td></tr>
                            ${semiMonthlyExpenses.filter(i => i.isPaid).map(item => renderRow(item.name, item.actual)).join('')}
                            <tr class="border-t"><td class="py-1 pr-4 text-gray-600 font-semibold text-right">Subtotal</td><td class="py-1 text-right font-semibold">${formatCurrency(totalSemiMonthly)}</td></tr>

                            <tr class="font-medium bg-gray-50"><td class="py-1 px-2 mt-2" colspan="2">Daily & Unplanned Expenses</td></tr>
                            ${variableExpenses.map(item => renderRow(item.name, item.amount)).join('')}
                            <tr class="border-t"><td class="py-1 pr-4 text-gray-600 font-semibold text-right">Subtotal</td><td class="py-1 text-right font-semibold">${formatCurrency(totalVariable)}</td></tr>
                            
                            ${renderHeaderRow('Total Expenses', totalExpenses)}
                        </tbody>
                    </table>
                    
                    <table class="w-full text-sm mt-6">
                        <tbody>
                            ${renderFinalRow('Net Income / Loss', netIncome)}
                        </tbody>
                    </table>
                </div>
            `;
        }


        // --- Event Handlers ---
        
        /** Attaches listeners for navigation */
        function attachNavListeners() {
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.onclick = (e) => {
                    state.view = e.currentTarget.dataset.view;
                    renderApp();
                };
            });
            document.getElementById('sign-out-button').onclick = async () => {
                try {
                    await signOut(auth);
                    // onAuthStateChanged will handle the redirect to login
                    console.log("User signed out.");
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            };
        }

        /** Attaches listeners for the main content area */
        function attachMainListeners() {
            if (state.view === 'tracker') {
                document.getElementById('month-select').onchange = (e) => {
                    state.currentMonthId = e.target.value;
                    state.currentBudget = null; // Force reload
                    state.loading = true;
                    // Detach old listener and setup new one
                    state.unsubBudget();
                    setupBudgetListener(state.currentMonthId);
                    renderApp(); // Show loading
                };
                
                document.querySelectorAll('.payout-edit').forEach(btn => {
                    btn.onclick = (e) => showPayoutModal(e.currentTarget.dataset.payoutKey);
                });
                document.querySelectorAll('.payout-unpay').forEach(btn => {
                    btn.onclick = (e) => handlePayoutUnpay(e.currentTarget.dataset.payoutKey);
                });

                document.querySelectorAll('.expense-edit').forEach(btn => {
                    btn.onclick = (e) => showExpenseModal(e.currentTarget.dataset.key, e.currentTarget.dataset.index);
                });
                document.querySelectorAll('.expense-unpay').forEach(btn => {
                    btn.onclick = (e) => handleExpenseUnpay(e.currentTarget.dataset.key, e.currentTarget.dataset.index);
                });
                
                document.getElementById('variable-expense-form').onsubmit = handleVariableSave;
                document.querySelectorAll('.variable-delete').forEach(btn => {
                    btn.onclick = (e) => handleVariableDelete(e.currentTarget.dataset.id);
                });

            } else if (state.view === 'settings') {
                document.getElementById('save-income-settings').onclick = handleIncomeSettingsSave;
                
                document.querySelectorAll('.template-add').forEach(btn => {
                    btn.onclick = (e) => handleTemplateAdd(e.currentTarget.dataset.key, e.currentTarget.dataset.isFixed === 'true');
                });
                document.querySelectorAll('.template-edit').forEach(btn => {
                    btn.onclick = (e) => handleTemplateEdit(e.currentTarget.dataset.key, e.currentTarget.dataset.id, e.currentTarget.dataset.isFixed === 'true');
                });
                document.querySelectorAll('.template-delete').forEach(btn => {
                    btn.onclick = (e) => handleTemplateDelete(e.currentTarget.dataset.key, e.currentTarget.dataset.id);
                });
            } else if (state.view === 'reports') {
                const reportMonthSelect = document.getElementById('report-month-select');
                reportMonthSelect.onchange = (e) => generateReport(e.target.value);
                // Auto-load report for the default selected month
                generateReport(reportMonthSelect.value);
                
                document.getElementById('print-report-button').onclick = () => {
                    window.print();
                };
            }
        }
        
        /** NEW: Handles Google Sign-In */
        async function handleGoogleSignIn() {
            try {
                // This will open the Google sign-in popup
                const result = await signInWithPopup(auth, googleProvider);
                // onAuthStateChanged will handle the successful login
                console.log("Signed in with Google:", result.user.uid);
            } catch (error) {
                console.error("Error during Google sign-in popup:", error);
                
                // Handle common errors
                if (error.code === 'auth/popup-closed-by-user') {
                    // User closed the popup, do nothing
                    return;
                }
                if (error.code === 'auth/unauthorized-domain') {
                    // This is a common setup error
                    appRoot.innerHTML = `<div class="p-8 text-center text-red-600 no-print">
                        <h2 class="text-2xl font-bold">Sign-In Error</h2>
                        <p class="mt-2">This domain is not authorized to sign in. You must add it to the Firebase console.</p>
                        <p class="mt-4 text-sm text-gray-700"><strong>How to fix:</strong>
                            <ol class="text-left list-decimal list-inside mt-2 max-w-lg mx-auto">
                                <li>Go to your Firebase project console.</li>
                                <li>Click on <strong>Build > Authentication</strong>.</li>
                                <li>Click the <strong>Settings</strong> tab.</li>
                                <li>Under <strong>Authorized domains</strong>, click <strong>Add domain</strong>.</li>
                                <li>Add this domain: <code>${window.location.hostname}</code></li>
                                <li>Click <strong>Add</strong>.</li>
                            </ol>
                        </p>
                    </div>`;
                    return;
                }
                
                // Show a generic error for other issues
                appRoot.innerHTML = `<div class="p-8 text-center text-red-600 no-print">
                        <h2 class="text-2xl font-bold">Sign-In Error</h2>
                        <p class="mt-2">${error.message}</p>
                        <p class="mt-4 text-sm text-gray-700">Please try again. Make sure popups are enabled for this site.</p>
                    </div>`;
            }
        }

        // --- Data Logic (Saving/Updating) ---
        
        /** Save payout modal form */
        async function handlePayoutSave(e) {
            e.preventDefault();
            const payoutKey = e.target.dataset.key;
            const amount = Number(document.getElementById('modal-amount').value);
            
            const updatedBudget = {
                ...state.currentBudget,
                income: {
                    ...state.currentBudget.income,
                    [payoutKey]: {
                        ...state.currentBudget.income[payoutKey],
                        actual: amount,
                        isPaid: true,
                    }
                }
            };
            
            await updateDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'budgets', state.currentMonthId), updatedBudget);
            hideModal();
        }

        /** Mark payout as unpaid */
        async function handlePayoutUnpay(payoutKey) {
             const updatedBudget = {
                ...state.currentBudget,
                income: {
                    ...state.currentBudget.income,
                    [payoutKey]: {
                        ...state.currentBudget.income[payoutKey],
                        actual: 0,
                        isPaid: false,
                    }
                }
            };
            await updateDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'budgets', state.currentMonthId), updatedBudget);
        }

        /** Save expense modal form */
        async function handleExpenseSave(e) {
            e.preventDefault();
            const { key, index } = e.target.dataset;
            const amount = Number(document.getElementById('modal-amount').value);
            
            const updatedExpenses = [...state.currentBudget[key]];
            updatedExpenses[index] = {
                ...updatedExpenses[index],
                actual: amount,
                isPaid: true,
            };
            
            const updatedBudget = { ...state.currentBudget, [key]: updatedExpenses };
            await updateDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'budgets', state.currentMonthId), updatedBudget);
            hideModal();
        }

        /** Mark expense as unpaid */
        async function handleExpenseUnpay(key, index) {
            const updatedExpenses = [...state.currentBudget[key]];
            updatedExpenses[index] = {
                ...updatedExpenses[index],
                actual: 0,
                isPaid: false,
            };
            const updatedBudget = { ...state.currentBudget, [key]: updatedExpenses };
            await updateDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'budgets', state.currentMonthId), updatedBudget);
        }

        /** Save new variable expense */
        async function handleVariableSave(e) {
            e.preventDefault();
            const name = document.getElementById('variable-name').value;
            const amount = Number(document.getElementById('variable-amount').value);
            if (!name || !amount) return;

            const newExpense = {
                id: `var-${new Date().getTime()}`,
                name,
                amount,
                date: new Date().toISOString(),
            };

            await updateDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'budgets', state.currentMonthId), {
                variableExpenses: arrayUnion(newExpense)
            });
            document.getElementById('variable-name').value = '';
            document.getElementById('variable-amount').value = '';
        }

        /** Delete variable expense */
        async function handleVariableDelete(id) {
            const itemToDelete = state.currentBudget.variableExpenses.find(item => item.id === id);
            if (itemToDelete) {
                await updateDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'budgets', state.currentMonthId), {
                    variableExpenses: arrayRemove(itemToDelete)
                });
            }
        }

        /** Save income settings */
        async function handleIncomeSettingsSave() {
            const payout1 = Number(document.getElementById('setting-payout1').value);
            const payout2 = Number(document.getElementById('setting-payout2').value);
            const payout1Label = document.getElementById('setting-payout1-label').value;
            const payout2Label = document.getElementById('setting-payout2-label').value;
            
            await updateDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'settings', 'main'), {
                avgPayout1: payout1,
                avgPayout2: payout2,
                payout1Label: payout1Label,
                payout2Label: payout2Label
            });
        }
        
        /** Show template add modal */
        function handleTemplateAdd(key, isFixedExpense) {
            const newItem = {
                id: `tpl-${new Date().getTime()}`,
                name: "",
                expected: 0,
                paymentType: 'monthly', // Default to monthly
                dueMonth: '',
                monthlyDueDate: isFixedExpense ? '' : undefined,
                endTerm: isFixedExpense ? '' : undefined,
            };
            showTemplateModal(key, newItem, true, isFixedExpense);
        }
        
        /** Show template edit modal */
        function handleTemplateEdit(key, id, isFixedExpense) {
            const item = state.settings[key].find(i => i.id === id);
            showTemplateModal(key, item, false, isFixedExpense);
        }

        /** Save template modal form */
        async function handleTemplateSave(e) {
            e.preventDefault();
            const { key, id, isNew, isFixed } = e.target.dataset;
            const isFixedExpense = isFixed === 'true';

            const updatedItem = {
                id: id,
                name: document.getElementById('template-name').value,
                expected: Number(document.getElementById('template-expected').value),
                paymentType: document.getElementById('template-payment-type').value,
                dueMonth: document.getElementById('template-due-month')?.value || '',
                monthlyDueDate: isFixedExpense ? document.getElementById('template-due-date')?.value || '' : undefined,
                endTerm: isFixedExpense ? document.getElementById('template-end-term')?.value || '' : undefined,
            };
            
            let updatedItems;
            if (isNew === 'true') {
                updatedItems = [...state.settings[key], updatedItem];
            } else {
                updatedItems = state.settings[key].map(i => i.id === id ? updatedItem : i);
            }
            
            await updateDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'settings', 'main'), {
                [key]: updatedItems
            });
            hideModal();
        }

        /** Delete template item */
        async function handleTemplateDelete(key, id) {
            // A custom modal would be better than confirm().
            const customModalContent = `
                <h3 class="text-lg font-medium mb-4">Confirm Deletion</h3>
                <p class="text-sm text-gray-600 mb-4">Are you sure you want to delete this template? This will not affect past budgets.</p>
                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" id="modal-cancel" class="font-medium rounded-lg transition-colors bg-transparent text-gray-700 hover:bg-gray-100 px-4 py-2 text-sm">Cancel</button>
                    <button type="button" id="modal-confirm-delete" class="font-medium rounded-lg transition-colors bg-red-600 text-white hover:bg-red-700 px-4 py-2 text-sm">Delete</button>
                </div>
            `;
            showModal(customModalContent);

            document.getElementById('modal-cancel').onclick = hideModal;
            document.getElementById('modal-confirm-delete').onclick = async () => {
                const itemToDelete = state.settings[key].find(i => i.id === id);
                if (itemToDelete) {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'settings', 'main'), {
                        [key]: arrayRemove(itemToDelete)
                    });
                }
                hideModal();
            };
        }
        
        // --- Modal & Form Logic (The missing functions) ---

        /** Shows the modal with specific content */
        function showModal(content) {
            modalContent.innerHTML = content;
            modalContainer.classList.remove('hidden');
        }

        /** Hides the modal */
        function hideModal() {
            modalContent.innerHTML = '';
            modalContainer.classList.add('hidden');
        }
        
        /** Shows the form for editing an income payout */
        function showPayoutModal(payoutKey) {
            const payout = state.currentBudget.income[payoutKey];
            const title = payoutKey === 'payout1' ? state.settings.payout1Label : state.settings.payout2Label;
            const amount = payout.isPaid ? payout.actual : payout.expected;
            
            const content = `
                <form id="payout-modal-form" data-key="${payoutKey}">
                    <h3 class="text-lg font-medium mb-4">Edit Payout</h3>
                    <p class="text-sm text-gray-600 mb-4">Enter the actual amount received for ${title}.</p>
                    <label class="block text-sm font-medium mb-1">Actual Amount</label>
                    <input type="number" id="modal-amount" value="${amount}" class="border border-gray-300 rounded-lg p-2 text-sm w-full focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                    <div class="flex justify-end space-x-2 mt-4">
                        <button type="button" id="modal-cancel" class="font-medium rounded-lg transition-colors bg-transparent text-gray-700 hover:bg-gray-100 px-4 py-2 text-sm">Cancel</button>
                        <button type="submit" class="font-medium rounded-lg transition-colors bg-blue-600 text-white hover:bg-blue-700 px-4 py-2 text-sm">Save</button>
                    </div>
                </form>
            `;
            showModal(content);
            document.getElementById('modal-cancel').onclick = hideModal;
            document.getElementById('payout-modal-form').onsubmit = handlePayoutSave;
        }

        /** Shows the form for editing a recurring expense */
        function showExpenseModal(expenseKey, index) {
            const item = state.currentBudget[expenseKey][index];
            const amount = item.isPaid ? item.actual : item.expected;
            
            const content = `
                <form id="expense-modal-form" data-key="${expenseKey}" data-index="${index}">
                    <h3 class="text-lg font-medium mb-4">Pay Expense</h3>
                    <p class="text-sm text-gray-600 mb-4">Enter the actual amount paid for ${item.name}.</p>
                    <label class="block text-sm font-medium mb-1">Actual Amount</label>
                    <input type="number" id="modal-amount" value="${amount}" class="border border-gray-300 rounded-lg p-2 text-sm w-full focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                    <div class="flex justify-end space-x-2 mt-4">
                        <button type="button" id="modal-cancel" class="font-medium rounded-lg transition-colors bg-transparent text-gray-700 hover:bg-gray-100 px-4 py-2 text-sm">Cancel</button>
                        <button type="submit" class="font-medium rounded-lg transition-colors bg-blue-600 text-white hover:bg-blue-700 px-4 py-2 text-sm">Save Payment</button>
                    </div>
                </form>
            `;
            showModal(content);
            document.getElementById('modal-cancel').onclick = hideModal;
            document.getElementById('expense-modal-form').onsubmit = handleExpenseSave;
        }

        /** Shows the form for adding/editing a template item */
        function showTemplateModal(key, item, isNew = false, isFixedExpense = false) {
            const title = isNew ? 'Add New' : 'Edit';
            
            // This local state will track the selected payment type to show/hide fields
            let currentPaymentType = item.paymentType || 'monthly';
            
            const getModalContent = (paymentType) => `
                <form id="template-modal-form" data-key="${key}" data-id="${item.id}" data-is-new="${isNew}" data-is-fixed="${isFixedExpense}">
                    <h3 class="text-lg font-medium mb-4">${title} Item</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Name</label>
                            <input type="text" id="template-name" value="${item.name || ''}" class="border border-gray-300 rounded-lg p-2 text-sm w-full focus:ring-2 focus:ring-blue-500 focus:outline-none" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Expected Amount (Monthly Due)</label>
                            <input type="number" id="template-expected" value="${item.expected || 0}" class="border border-gray-300 rounded-lg p-2 text-sm w-full focus:ring-2 focus:ring-blue-500 focus:outline-none" required />
                        </div>
                        
                        <!-- NEW: Payment Type Selector -->
                        <div>
                            <label class="block text-sm font-medium mb-1">Payment Type</label>
                            <select id="template-payment-type" class="border border-gray-300 rounded-lg p-2 text-sm w-full focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="monthly" ${paymentType === 'monthly' ? 'selected' : ''}>Monthly Bill</option>
                                <option value="oneTime" ${paymentType === 'oneTime' ? 'selected' : ''}>One-Time Expense</option>
                            </select>
                        </div>

                        <!-- Conditional fields for "Monthly Bill" -->
                        ${paymentType === 'monthly' && isFixedExpense ? `
                        <div id="monthly-fields">
                            <div>
                                <label class="block text-sm font-medium mb-1">Monthly Due Date (e.g., "15th")</label>
                                <input type="text" id="template-due-date" value="${item.monthlyDueDate || ''}" class="border border-gray-300 rounded-lg p-2 text-sm w-full focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">End Term (Optional)</label>
                                <input type="month" id="template-end-term" value="${item.endTerm || ''}" class="border border-gray-300 rounded-lg p-2 text-sm w-full focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Conditional fields for "One-Time Expense" -->
                        ${paymentType === 'oneTime' ? `
                        <div id="one-time-fields">
                            <div>
                                <label class="block text-sm font-medium mb-1">Due Month (YYYY-MM)</label>
                                <input type="month" id="template-due-month" value="${item.dueMonth || ''}" class="border border-gray-300 rounded-lg p-2 text-sm w-full focus:ring-2 focus:ring-blue-500 focus:outline-none" required />
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" id="modal-cancel" class="font-medium rounded-lg transition-colors bg-transparent text-gray-700 hover:bg-gray-100 px-4 py-2 text-sm">Cancel</button>
                        <button type="submit" class="font-medium rounded-lg transition-colors bg-blue-600 text-white hover:bg-blue-700 px-4 py-2 text-sm">Save</button>
                    </div>
                </form>
            `;
            
            showModal(getModalContent(currentPaymentType));
            
            // Add listener to re-render modal on type change
            document.getElementById('template-payment-type').onchange = (e) => {
                currentPaymentType = e.target.value;
                // Preserve form data
                item.name = document.getElementById('template-name').value;
                item.expected = Number(document.getElementById('template-expected').value);
                if (document.getElementById('template-due-date')) {
                    item.monthlyDueDate = document.getElementById('template-due-date').value;
                }
                if (document.getElementById('template-end-term')) {
                    item.endTerm = document.getElementById('template-end-term').value;
                }
                 if (document.getElementById('template-due-month')) {
                    item.dueMonth = document.getElementById('template-due-month').value;
                }
                
                showModal(getModalContent(currentPaymentType)); // Re-render
                
                // Re-attach listeners after re-render
                document.getElementById('modal-cancel').onclick = hideModal;
                document.getElementById('template-modal-form').onsubmit = handleTemplateSave;
                document.getElementById('template-payment-type').onchange = arguments.callee; // Re-attach self
            };

            document.getElementById('modal-cancel').onclick = hideModal;
            document.getElementById('template-modal-form').onsubmit = handleTemplateSave;
        }

        // --- Initialization ---

        /** Creates a new budget doc for the month based on settings */
        async function createNewMonthBudget(monthId, settingsDoc) {
            
            const allTemplateExpenses = [
                ...settingsDoc.recurringTemplate, 
                ...settingsDoc.semiMonthlyExpensesTemplate
            ];

            const newRecurring = settingsDoc.recurringTemplate
                .filter(item => item.paymentType === 'monthly' || (item.paymentType === 'oneTime' && item.dueMonth === monthId))
                .map(item => ({ ...item, actual: 0, isPaid: false }));
                
            const newSemiMonthly = settingsDoc.semiMonthlyExpensesTemplate
                .filter(item => item.paymentType === 'monthly' || (item.paymentType === 'oneTime' && item.dueMonth === monthId))
                .map(item => ({ ...item, actual: 0, isPaid: false }));

            const newBudget = {
                month: monthId,
                income: {
                    payout1: { expected: settingsDoc.avgPayout1, actual: 0, isPaid: false },
                    payout2: { expected: settingsDoc.avgPayout2, actual: 0, isPaid: false },
                },
                recurringExpenses: newRecurring,
                semiMonthlyExpenses: newSemiMonthly,
                variableExpenses: [],
            };
            
            try {
                // Set the new budget
                await setDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'budgets', monthId), newBudget);
                // The onSnapshot listener will then pick it up
            } catch (error)
            {
                // This is the OTHER likely error: Firestore rules not set to 'test mode'
                console.error("Error creating new month budget:", error);
                if (error.code === 'permission-denied') {
                    console.error("===================================================================");
                    console.error("APP FIX: Firestore permission denied. You MUST set your Firestore rules to 'test mode'.");
                    console.error("HOW TO FIX: Go to Firebase Console > Build > Firestore Database > Rules (tab)");
                    console.error("Change `allow read, write: if false;` to `allow read, write: if true;`");
                    console.error("Click 'Publish'.");
                    console.error("===================================================================");
                    appRoot.innerHTML = `<div class="p-8 text-center text-red-600 no-print">
                        <h2 class="text-2xl font-bold">Database Error</h2>
                        <p class="mt-2">Permission denied. You need to enable <strong>Test Mode</strong> in your Firestore database.</p>
                        <p class="mt-4 text-sm text-gray-700"><strong>How to fix:</strong>
                            <ol class="text-left list-decimal list-inside mt-2 max-w-lg mx-auto">
                                <li>Go to your Firebase project console.</li>
                                <li>Click on <strong>Build > Firestore Database</strong>.</li>
                                <li>Click the <strong>Rules</strong> tab.</li>
                                <li>Change the line <code>allow read, write: if false;</code> to <code>allow read, write: if true;</code></li>
                                <li>Click <strong>Publish</strong>.</li>
                            </ol>
                        </p>
                    </div>`;
                    state.loading = false; // Stop loading, show error
                }
            }
        }

        /** Sets up the listener for the current month's budget */
        function setupBudgetListener(monthId) {
            state.unsubBudget(); // Unsubscribe from old budget
            const budgetRef = doc(db, 'artifacts', appId, 'users', state.userId, 'budgets', monthId);
            
            state.unsubBudget = onSnapshot(budgetRef, async (docSnap) => {
                if (docSnap.exists()) {
                    state.currentBudget = docSnap.data();
                    state.loading = false;
                    renderApp();
                } else {
                    // If budget doesn't exist, and settings are loaded, create new budget
                    if (state.settings) {
                        await createNewMonthBudget(monthId, state.settings);
                    }
                    // else: we're still waiting for settings, do nothing
                }
            }, (error) => {
                // Handle snapshot errors (likely permission denied)
                console.error("Error listening to budget:", error);
                if (error.code === 'permission-denied') {
                    appRoot.innerHTML = `<div class="p-8 text-center text-red-600 no-print">
                        <h2 class="text-2xl font-bold">Database Error</h2>
                        <p class="mt-2">Permission denied. You need to enable <strong>Test Mode</strong> in your Firestore database.</p>
                        <p class="mt-4 text-sm text-gray-700"><strong>How to fix:</strong>
                            <ol class="text-left list-decimal list-inside mt-2 max-w-lg mx-auto">
                                <li>Go to your Firebase project console.</li>
                                <li>Click on <strong>Build > Firestore Database</strong>.</li>
                                <li>Click the <strong>Rules</strong> tab.</li>
                                <li>Change the line <code>allow read, write: if false;</code> to <code>allow read, write: if true;</code></li>
                                <li>Click <strong>Publish</strong>.</li>
                            </ol>
                        </p>
                    </div>`;
                    state.loading = false;
                }
            });
        }
        
        /** Attaches listeners for data (Settings and Budget) */
        function attachDataListeners() {
            // 1. Setup settings listener
            const settingsRef = doc(db, 'artifacts', appId, 'users', state.userId, 'settings', 'main');
            state.unsubSettings = onSnapshot(settingsRef, async (docSnap) => {
                if (docSnap.exists()) {
                    state.settings = docSnap.data();
                } else {
                    // Create default settings
                    const defaultSettings = {
                        avgPayout1: 19000,
                        avgPayout2: 19000,
                        payout1Label: "Payout 1 (10th)",
                        payout2Label: "Payout 2 (25th)",
                        recurringTemplate: [],
                        semiMonthlyExpensesTemplate: [], // Renamed
                    };
                    await setDoc(settingsRef, defaultSettings);
                    state.settings = defaultSettings;
                }
                // Once settings are loaded, setup budget listener
                setupBudgetListener(state.currentMonthId);
            }, (error) => {
                // Handle settings snapshot errors (likely permission denied)
                console.error("Error listening to settings:", error);
                if (error.code === 'permission-denied') {
                    appRoot.innerHTML = `<div class="p-8 text-center text-red-600 no-print">
                        <h2 class="text-2xl font-bold">Database Error</h2>
                        <p class="mt-2">Permission denied. You need to enable <strong>Test Mode</strong> in your Firestore database.</p>
                        <p class="mt-4 text-sm text-gray-700"><strong>How to fix:</strong>
                            <ol class="text-left list-decimal list-inside mt-2 max-w-lg mx-auto">
                                <li>Go to your Firebase project console.</li>
                                <li>Click on <strong>Build > Firestore Database</strong>.</li>
                                <li>Click the <strong>Rules</strong> tab.</li>
                                <li>Change the line <code>allow read, write: if false;</code> to <code>allow read, write: if true;</code></li>
                                <li>Click <strong>Publish</strong>.</li>
                            </ol>
                        </p>
                    </div>`;
                    state.loading = false;
                }
            });
        }

        /** Initializes the application */
        async function main() {
            renderApp(); // Show initial loading screen
            
            try {
                app = initializeApp(firebaseConfig);
                analytics = getAnalytics(app);
                auth = getAuth(app);
                db = getFirestore(app);
                googleProvider = new GoogleAuthProvider(); // Initialize Google provider
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in!
                        state.userId = user.uid;
                        state.isAuthReady = true;
                        state.loading = true; // Set to loading while we fetch data
                        
                        // Detach any old listeners before attaching new ones
                        state.unsubSettings();
                        state.unsubBudget();
                        
                        attachDataListeners(); // This will fetch data and render the app
                        
                    } else {
                        // User is signed out!
                        state.userId = null;
                        state.isAuthReady = false;
                        state.loading = false;
                        
                        // Detach listeners
                        state.unsubSettings();
                        state.unsubBudget();
                        
                        renderLoginScreen(); // Show the login screen
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                appRoot.innerHTML = `<div class="p-8 text-center text-red-600 no-print">
                    <h2 class="text-2xl font-bold">Error connecting to database</h2>
                    <p class=mt-2>Could not initialize Firebase. Please check your console and Firebase configuration.</p>
                </div>`;
            }
        }
        
        // Start the application
        main();

    </script>
</body>
</html>
